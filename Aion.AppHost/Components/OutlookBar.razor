@using Aion.Domain.UI
@using Aion.Domain.Contracts
@using Aion.DataEngine.Entities
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using System.Collections.Generic
@using System
@using System.Linq
@using System.Threading
@using Aion.Domain.UI.Navigation
@using Aion.Domain.Services.Navigation
@inject IMenuProvider MenuProvider
@inject IAionNavigationService Navigation
@inject IModuleCatalog ModuleCatalog
@inject AuthenticationStateProvider Auth

<FluentSearch @bind-Value="Filter" Placeholder="Rechercher..." Class="mb-2" />

@if (_menus is null)
{
    <FluentProgressRing />
}
else if (!_menus.Any())
{
    <div class="text-muted p-3">
        <p>Aucun menu disponible.</p>
        <small>Contactez votre administrateur pour obtenir les droits nécessaires.</small>
    </div>
}
else
{
    <FluentTreeView>
        @foreach (var root in _rootNodes)
        {
            @RenderTreeItem(root)
        }
    </FluentTreeView>
}

@code {
    private IReadOnlyList<SMenu>? _menus;
    private List<SMenu> _rootNodes = new();
    private readonly Dictionary<int, List<SMenu>> Children = new();
    private string _filter = string.Empty;

    private string Filter
    {
        get => _filter;
        set
        {
            if (_filter != value)
            {
                _filter = value;
                if (_menus != null)
                {
                    BuildTree();
                }
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var state = await Auth.GetAuthenticationStateAsync();
            var user = state.User;

            // Récupération sécurisée des claims
            var userIdClaim = user.FindFirst("sub");
            var tenantIdClaim = user.FindFirst("tenant");

            if (userIdClaim == null || !int.TryParse(userIdClaim.Value, out var userId))
            {
                // Utilisateur non authentifié ou claim invalide
                _menus = new List<SMenu>();
                return;
            }

            if (tenantIdClaim == null || !int.TryParse(tenantIdClaim.Value, out var tenantId))
            {
                // Tenant non défini
                _menus = new List<SMenu>();
                return;
            }

            // Récupération des menus autorisés (filtrage RBAC côté serveur)
            _menus = await MenuProvider.GetAuthorizedMenuAsync(tenantId, userId, default);

            BuildTree();
        }
        catch (Exception ex)
        {
            // Log l'erreur en production
            Console.WriteLine($"Erreur chargement menus: {ex.Message}");
            _menus = new List<SMenu>();
        }
    }

    private void BuildTree()
    {
        if (_menus == null || !_menus.Any())
        {
            Children.Clear();
            _rootNodes = new List<SMenu>();
            return;
        }

        var query = FilterMenus();

        Children.Clear();

        foreach (var menu in query.Where(x => x.ParentId.HasValue))
        {
            if (!Children.TryGetValue(menu.ParentId!.Value, out var list))
            {
                list = new List<SMenu>();
                Children[menu.ParentId.Value] = list;
            }

            list.Add(menu);
        }

        foreach (var childList in Children.Values)
        {
            childList.Sort((a, b) => a.Order.CompareTo(b.Order));
        }

        _rootNodes = query
            .Where(x => !x.ParentId.HasValue)
            .OrderBy(x => x.Order)
            .ToList();
    }

    private List<SMenu> FilterMenus()
    {
        if (_menus == null)
        {
            return new List<SMenu>();
        }

        if (string.IsNullOrWhiteSpace(_filter))
        {
            return _menus
                .OrderBy(m => m.Order)
                .ToList();
        }

        var comparer = StringComparison.OrdinalIgnoreCase;
        var allMenus = _menus.ToDictionary(m => m.Id);
        var selected = new HashSet<int>();

        foreach (var menu in _menus)
        {
            if (menu.Libelle.Contains(_filter, comparer))
            {
                var current = menu;
                while (current != null)
                {
                    if (!selected.Add(current.Id))
                    {
                        break;
                    }

                    if (current.ParentId.HasValue && allMenus.TryGetValue(current.ParentId.Value, out var parent))
                    {
                        current = parent;
                    }
                    else
                    {
                        current = null;
                    }
                }
            }
        }

        if (!selected.Any())
        {
            return new List<SMenu>();
        }

        var queue = new Queue<int>(selected);
        while (queue.Count > 0)
        {
            var id = queue.Dequeue();
            foreach (var child in _menus.Where(m => m.ParentId == id))
            {
                if (selected.Add(child.Id))
                {
                    queue.Enqueue(child.Id);
                }
            }
        }

        return _menus
            .Where(m => selected.Contains(m.Id))
            .OrderBy(m => m.Order)
            .ToList();
    }

    private async Task OnClick(SMenu item)
    {
        if (!item.IsLeaf || item.Module is null || string.IsNullOrEmpty(item.Module.Route))
        {
            return;
        }

        var module = await ModuleCatalog.TryGetByKeyAsync(item.Module.Name, CancellationToken.None);
        if (module is null)
        {
            return;
        }

        var parameters = NavigationParameterParser.BuildDefaultParameters(item.Module.Route, item.Parametre);
        await Navigation.OpenModuleAsync(module.Key, parameters, CancellationToken.None);
    }

    protected override void OnParametersSet()
    {
        if (_menus != null)
        {
            BuildTree();
        }
    }

    private RenderFragment RenderTreeItem(SMenu menu) => builder =>
    {
        builder.OpenComponent<FluentTreeItem>(0);
        builder.AddAttribute(1, "Text", menu.Libelle);
        builder.AddAttribute(2, "onclick", EventCallback.Factory.Create(this, () => OnClick(menu)));

        if (Children.TryGetValue(menu.Id, out var children) && children.Count > 0)
        {
            builder.AddAttribute(3, "ChildContent", (RenderFragment)(childBuilder =>
            {
                foreach (var child in children)
                {
                    childBuilder.AddContent(4, RenderTreeItem(child));
                }
            }));
        }

        builder.CloseComponent();
    };
}

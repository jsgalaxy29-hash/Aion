@inherits LayoutComponentBase
@using Aion.AppHost.Services
@using Aion.Domain.Contracts
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.FluentUI.AspNetCore.Components
@inject AuthenticationStateProvider Auth
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IAionThemeService ThemeService
@implements IDisposable

<FluentStack Horizontal="true" Style="height:100vh">
    <!-- Outlook bar (menu) -->
    <div class="p-2" style="width:260px; overflow:auto">
        @if (_authState?.User.Identity?.IsAuthenticated == true)
        {
            <OutlookBar />
        }
    </div>
    <FluentDivider Vertical="true" />
    <!-- Main content area -->
    <div class="flex-grow p-2 overflow-auto">
        @if (_authState?.User.Identity?.IsAuthenticated == true)
        {
            <TabHost />
        }
        else
        {
            @Body
        }
    </div>
    <!-- Simple header with user info and sign out -->
    <div class="position-fixed top-0 end-0 p-2" style="z-index:1000">
        @if (_authState?.User.Identity?.IsAuthenticated == true)
        {
            <div class="d-flex gap-2 align-items-center">
                <FluentSelect TOption="string" Value="_selectedTheme" ValueChanged="OnThemeSelectionChanged" Style="min-width: 140px;">
                    <FluentOption Value="light">Thème clair</FluentOption>
                    <FluentOption Value="dark">Thème sombre</FluentOption>
                </FluentSelect>
                <FluentButton OnClick="Logout">Se déconnecter (@_authState.User.Identity?.Name)</FluentButton>
            </div>
        }
    </div>
</FluentStack>




@code {
    private AuthenticationState? _authState;
    private string _selectedTheme = "light";

    protected override async Task OnInitializedAsync()
    {
        ThemeService.ThemeChanged += OnThemeChanged;
        _selectedTheme = ThemeService.Current.Mode == DesignThemeModes.Dark ? "dark" : "light";
        _authState = await Auth.GetAuthenticationStateAsync();
    }

    private void OnThemeChanged()
    {
        _selectedTheme = ThemeService.Current.Mode == DesignThemeModes.Dark ? "dark" : "light";
        _ = InvokeAsync(StateHasChanged);
    }

    private Task OnThemeSelectionChanged(string? value)
    {
        if (string.Equals(value, "dark", StringComparison.OrdinalIgnoreCase))
        {
            ThemeService.UseDark();
        }
        else
        {
            ThemeService.UseLight();
        }

        return Task.CompletedTask;
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login", true);
    }

    public void Dispose()
    {
        ThemeService.ThemeChanged -= OnThemeChanged;
    }
}

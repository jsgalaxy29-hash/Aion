@inherits LayoutComponentBase
@using Aion.AppHost.Services
@using Aion.Domain.Contracts
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.FluentUI.AspNetCore.Components
@inject AuthenticationStateProvider Auth
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IAionThemeService ThemeService
@implements IDisposable

<FluentDesignTheme Mode="@ThemeService.Current.Mode"
                   NeutralBaseColor="@ThemeService.Current.NeutralBaseColor"
                   OfficeColor="@ThemeService.Current.OfficeColor"
                   CustomColor="@ThemeService.Current.CustomColor">

        <!-- FullCalendar CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" />

     <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/fullcalendar/daygrid@6.1.15/index.global.min.css" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/fullcalendar/timegrid@6.1.15/index.global.min.css" />

    @* Conteneur horizontal plein écran *@
    <FluentStack Horizontal="true" Style="height:100vh; max-height:100vh;">

        @* Outlook bar (menu) *@
        <div class="p-2" style="flex:0 0 260px; width:260px; overflow:auto;">
            @if (_authState?.User.Identity?.IsAuthenticated == true)
            {
                <OutlookBar />
            }
        </div>

        <FluentDivider Vertical="true" />

        @* Zone principale qui prend tout le reste *@
        <div style="flex:1; min-width:0; height:100%; display:flex; flex-direction:column; overflow-x:auto;">
            @if (_authState?.User.Identity?.IsAuthenticated == true)
            {
                @* TabHost peut maintenant occuper 100% de la zone principale *@
                <TabHost />
            }
            else
            {
                @Body
            }
        </div>

        @* Header fixe en haut à droite *@
        <div class="position-fixed top-0 end-0 p-2" style="z-index:1000">
            @if (_authState?.User.Identity?.IsAuthenticated == true)
            {
                <div class="d-flex gap-2 align-items-center">
                    <FluentSelect TOption="string"
                                  Value="_selectedTheme"
                                  ValueChanged="OnThemeSelectionChanged"
                                  Style="min-width: 140px;">
                        <FluentOption Value="light">Thème clair</FluentOption>
                        <FluentOption Value="dark">Thème sombre</FluentOption>
                    </FluentSelect>

                    <FluentButton OnClick="Logout">
                        Se déconnecter (@_authState.User.Identity?.Name)
                    </FluentButton>
                </div>
            }
        </div>
    </FluentStack>

    @* Providers FluentUI à mettre en bas du layout *@
    <FluentToastProvider />
    <FluentDialogProvider />
    <FluentTooltipProvider />
    <FluentMessageBarProvider />
    <FluentMenuProvider />

</FluentDesignTheme>

@code {
    private AuthenticationState? _authState;
    private string _selectedTheme = "light";

    protected override async Task OnInitializedAsync()
    {
        ThemeService.ThemeChanged += OnThemeChanged;
        _selectedTheme = ThemeService.Current.Mode == DesignThemeModes.Dark ? "dark" : "light";
        _authState = await Auth.GetAuthenticationStateAsync();
    }

    private void OnThemeChanged()
    {
        _selectedTheme = ThemeService.Current.Mode == DesignThemeModes.Dark ? "dark" : "light";
        _ = InvokeAsync(StateHasChanged);
    }

    private Task OnThemeSelectionChanged(string? value)
    {
        if (string.Equals(value, "dark", StringComparison.OrdinalIgnoreCase))
        {
            ThemeService.UseDark();
        }
        else
        {
            ThemeService.UseLight();
        }

        return Task.CompletedTask;
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login", true);
    }

    public void Dispose()
    {
        ThemeService.ThemeChanged -= OnThemeChanged;
    }
}


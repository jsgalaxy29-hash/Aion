@page "/agenda"
@using Aion.DataEngine.Interfaces
@using Aion.Infrastructure
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.JSInterop
@using System.Globalization
@using System.Linq
@using Aion.Domain.Agenda
@inject IAgendaService AgendaService
@inject IUserContext UserContext
@inject IDbContextFactory<AionDbContext> DbContextFactory
@inject IJSRuntime JS
@attribute [Authorize]

<div class="google-agenda-container">
    @if (!_loaded)
    {
        <div class="agenda-loading">
            <FluentProgressRing />
            <FluentLabel>Chargement des agendas...</FluentLabel>
        </div>
    }
    else if (!_agendas.Any())
    {
        <FluentMessageBar Intent="MessageIntent.Warning">
            Aucun agenda disponible pour cet utilisateur.
        </FluentMessageBar>
    }
    else
    {
        <!-- En-tête style Google Agenda -->
        <div class="agenda-header">
            <div class="header-left">
                <FluentButton Appearance="Appearance.Stealth" 
                              IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Navigation())"
                              Class="menu-toggle">
                </FluentButton>
                <div class="header-logo">
                    <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size24.Calendar())" Color="Color.Accent" />
                    <span class="header-title">Agenda</span>
                </div>
                <FluentButton Appearance="Appearance.Stealth" OnClick="GoToday" Class="today-btn">
                    Aujourd'hui
                </FluentButton>
                <div class="nav-buttons">
                    <FluentButton Appearance="Appearance.Stealth" 
                                  IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ChevronLeft())"
                                  OnClick="GoPrev" />
                    <FluentButton Appearance="Appearance.Stealth" 
                                  IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ChevronRight())"
                                  OnClick="GoNext" />
                </div>
                <h2 class="current-period">@GetCurrentPeriodTitle()</h2>
            </div>
            <div class="header-right">
                <FluentButton Appearance="Appearance.Stealth" 
                              IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Search())" />
                <FluentButton Appearance="Appearance.Stealth" 
                              IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Question())" />
                <FluentButton Appearance="Appearance.Stealth" 
                              IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Settings())" />

               <FluentSelect Toption="string" Value="@_currentView" Class="view-selector">
                    <FluentOption Value="dayGridMonth">Mois</FluentOption>
                    <FluentOption Value="timeGridWeek">Semaine</FluentOption>
                    <FluentOption Value="timeGridDay">Jour</FluentOption>
                    <FluentOption Value="listWeek">Agenda</FluentOption>
                </FluentSelect>

            </div>
        </div>

        <div class="agenda-layout">
            <!-- Sidebar gauche style Google -->
            <div class="agenda-sidebar">
                <!-- Bouton créer -->
                <FluentButton Appearance="Appearance.Accent"
                              IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Add())"
                              OnClick="OpenCreateDialog"
                              Class="create-button">
                    Créer
                </FluentButton>

                <!-- Mini calendrier -->
                <div class="mini-calendar">
                    <div class="mini-calendar-header">
                        <FluentButton Appearance="Appearance.Stealth" 
                                      IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.ChevronLeft())"
                                      OnClick="PreviousMiniMonth" />
                        <span class="mini-month-label">@_miniCalendarDate.ToString("MMMM yyyy", new CultureInfo("fr-FR"))</span>
                        <FluentButton Appearance="Appearance.Stealth" 
                                      IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.ChevronRight())"
                                      OnClick="NextMiniMonth" />
                    </div>
                    <div class="mini-calendar-body">
                        <div class="mini-calendar-weekdays">
                            @foreach (var day in new[] { "L", "M", "M", "J", "V", "S", "D" })
                            {
                                <div class="mini-weekday">@day</div>
                            }
                        </div>
                        <div class="mini-calendar-days">
                            @foreach (var day in GetMiniCalendarDays())
                            {
                                <button class="mini-day @GetMiniDayClass(day)" 
                                        @onclick="() => SelectMiniDay(day)">
                                    @day.Day
                                </button>
                            }
                        </div>
                    </div>
                </div>

                <!-- Liste des agendas -->
                <div class="agenda-list">
                    <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold" Class="agenda-list-title">
                        Mes agendas
                    </FluentLabel>
                    @foreach (var agenda in _agendas)
                    {
                        <div class="agenda-item">
                            <FluentCheckbox Checked="true" Class="agenda-checkbox">
                                <span class="agenda-color" style="background-color: @GetAgendaColor(agenda.Id);"></span>
                                <span class="agenda-name">@agenda.Libelle</span>
                            </FluentCheckbox>
                        </div>
                    }
                </div>

                <!-- Événements à venir -->
                <div class="upcoming-events">
                    <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold" Class="upcoming-title">
                        À venir
                    </FluentLabel>
                    @if (_events.Any(e => e.StartUtc >= DateTime.UtcNow))
                    {
                        @foreach (var evt in _events.Where(e => e.StartUtc >= DateTime.UtcNow).OrderBy(e => e.StartUtc).Take(5))
                        {
                            <div class="upcoming-event" @onclick="() => OnEventClickAsync(evt.Id.ToString())">
                                <div class="upcoming-event-time">
                                    <span class="event-color-dot" style="background-color: @GetAgendaColor(evt.AgendaId);"></span>
                                    @evt.StartUtc.ToLocalTime().ToString("t")
                                </div>
                                <div class="upcoming-event-title">@evt.Libelle</div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="no-upcoming">Aucun événement à venir</div>
                    }
                </div>
            </div>

            <!-- Zone principale du calendrier -->
            <div class="agenda-main">
                <FluentCard Class="calendar-card">
                    <div id="aion-agenda-calendar"></div>
                </FluentCard>
            </div>
        </div>

        <!-- Dialog de création d'événement style Google -->
        <FluentDialog @ref="_createEventDialog"
                      @bind-Hidden="CreateDialogHidden"
                      Class="event-dialog"
                      Modal="true"
                      TrapFocus="true"
                      @ondialogdismiss="OnCreateDialogDismiss">
            <FluentDialogHeader ShowDismiss="false">
                <div class="dialog-header">
                    <FluentLabel Typo="Typography.H5">Nouvel événement</FluentLabel>
                    <div class="dialog-actions">
                        <FluentButton Appearance="Appearance.Stealth" 
                                      IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Dismiss())"
                                      OnClick="CloseCreateDialog" />
                    </div>
                </div>
            </FluentDialogHeader>

            <FluentDialogBody>
                <EditForm Model="_formModel" OnValidSubmit="CreateEventAsync" Id="agenda-create-form">
                    <DataAnnotationsValidator />
                    
                    <div class="event-form">
                        <!-- Titre -->
                        <div class="form-row">
                            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.TextDescription())" Class="form-icon" />
                            <FluentTextField @bind-Value="_formModel.Libelle"
                                             Placeholder="Ajouter un titre"
                                             Class="title-input" />
                        </div>

                        <!-- Date et heure -->
                        <div class="form-row">
                            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Clock())" Class="form-icon" />
                            <div class="datetime-container">
                                <div class="datetime-row">
                                    <FluentDatePicker @bind-Value="_startDateLocal"
                                                      Placeholder="Date de début" />
                                    @if (!_formModel.AllDay)
                                    {
                                        <FluentTimePicker @bind-Value="_startTimeLocal" />
                                    }
                                </div>
                                <div class="datetime-row">
                                    <FluentDatePicker @bind-Value="_endDateLocal"
                                                      Placeholder="Date de fin" />
                                    @if (!_formModel.AllDay)
                                    {
                                        <FluentTimePicker @bind-Value="_endTimeLocal" />
                                    }
                                </div>
                                <FluentCheckbox @bind-Value="_formModel.AllDay" OnChange="OnAllDayChanged">
                                    Journée entière
                                </FluentCheckbox>
                            </div>
                        </div>

                        <!-- Agenda -->
                        <div class="form-row">
                            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.CalendarLtr())" Class="form-icon" />
                            <FluentSelect TOption="string"
                                          Value="@_selectedAgendaId"
                                          ValueChanged="OnAgendaChanged"
                                          Class="full-width">
                                @foreach (var agenda in _agendas)
                                {
                                    <FluentOption Value="@agenda.Id.ToString()">
                                        <span class="agenda-option">
                                            <span class="option-color" style="background-color: @GetAgendaColor(agenda.Id);"></span>
                                            @agenda.Libelle
                                        </span>
                                    </FluentOption>
                                }
                            </FluentSelect>
                        </div>

                        <!-- Description -->
                        <div class="form-row">
                            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.TextAlignLeft())" Class="form-icon" />
                            <FluentTextArea @bind-Value="_formModel.Description"
                                            Rows="3"
                                            Placeholder="Ajouter une description"
                                            Class="full-width" />
                        </div>

                        <!-- Statut -->
                        <div class="form-row">
                            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Status())" Class="form-icon" />
                            <FluentSelect TOption="string"
                                          Value="@_selectedStatusId"
                                          ValueChanged="OnStatusChanged"
                                          Class="full-width">
                                @foreach (var status in _statuses)
                                {
                                    <FluentOption Value="@status.Id.ToString()">@status.Libelle</FluentOption>
                                }
                            </FluentSelect>
                        </div>

                        <!-- Options supplémentaires -->
                        <div class="form-row">
                            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Options())" Class="form-icon" />
                            <div class="options-container">
                                <FluentCheckbox @bind-Value="_formModel.IsPrivate">Privé</FluentCheckbox>
                                <FluentCheckbox @bind-Value="_enableReminders" OnChange="OnReminderToggleChanged">
                                    Ajouter des rappels
                                </FluentCheckbox>
                            </div>
                        </div>

                        <!-- Rappels -->
                        @if (_enableReminders)
                        {
                            <div class="reminders-section">
                                @foreach (var reminder in _reminders)
                                {
                                    <div class="reminder-row">
                                        <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.Alert())" />
                                        <FluentNumberField TValue="int"
                                                           @bind-Value="reminder.OffsetMinutes"
                                                           Style="width: 80px;" />
                                        <span>min avant via</span>
                                        <FluentSelect TOption="string"
                                                      Value="@reminder.ChannelId.ToString()"
                                                      ValueChanged="@((string? value) => OnReminderChannelChanged(reminder, value))">
                                            @foreach (var ch in _channels)
                                            {
                                                <FluentOption Value="@ch.Id.ToString()">@ch.Libelle</FluentOption>
                                            }
                                        </FluentSelect>
                                        <FluentButton Appearance="Appearance.Stealth"
                                                      IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.Delete())"
                                                      OnClick="@(() => RemoveReminder(reminder))" />
                                    </div>
                                }
                                <FluentButton Appearance="Appearance.Stealth"
                                              IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.Add())"
                                              OnClick="AddReminder">
                                    Ajouter un rappel
                                </FluentButton>
                            </div>
                        }
                    </div>
                </EditForm>
            </FluentDialogBody>

            <FluentDialogFooter>
                <FluentStack Orientation="Orientation.Horizontal" Gap="8" HorizontalAlignment="HorizontalAlignment.Right">
                    <FluentButton Appearance="Appearance.Stealth" OnClick="CloseCreateDialog">
                        Annuler
                    </FluentButton>
                    <FluentButton Appearance="Appearance.Accent" Type="ButtonType.Submit" Form="agenda-create-form">
                        Enregistrer
                    </FluentButton>
                </FluentStack>
            </FluentDialogFooter>
        </FluentDialog>
    }
</div>

@implements IAsyncDisposable

<style>
    /* === Style Google Agenda === */
    .google-agenda-container {
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: var(--neutral-layer-1);
        overflow: hidden;
    }

    /* En-tête */
    .agenda-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 16px;
        border-bottom: 1px solid var(--neutral-stroke-divider-rest);
        background: var(--neutral-layer-2);
        min-height: 64px;
    }

    .header-left, .header-right {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .header-logo {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-right: 16px;
    }

    .header-title {
        font-size: 22px;
        font-weight: 400;
        color: var(--neutral-foreground-rest);
    }

    .today-btn {
        border: 1px solid var(--neutral-stroke-control-rest);
        padding: 0 24px;
        border-radius: 4px;
    }

    .nav-buttons {
        display: flex;
        gap: 4px;
    }

    .current-period {
        font-size: 22px;
        font-weight: 400;
        margin: 0;
        margin-left: 16px;
        color: var(--neutral-foreground-rest);
    }

    .view-selector {
        min-width: 140px;
    }

    /* Layout principal */
    .agenda-layout {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    /* Sidebar */
    .agenda-sidebar {
        width: 256px;
        padding: 16px;
        border-right: 1px solid var(--neutral-stroke-divider-rest);
        overflow-y: auto;
        background: var(--neutral-layer-2);
    }

    .create-button {
        width: 100%;
        justify-content: flex-start;
        margin-bottom: 24px;
        border-radius: 24px;
        padding: 12px 24px;
        box-shadow: 0 1px 2px 0 rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    }

    /* Mini calendrier */
    .mini-calendar {
        margin-bottom: 24px;
    }

    .mini-calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .mini-month-label {
        font-size: 14px;
        font-weight: 500;
        flex: 1;
        text-align: center;
    }

    .mini-calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        margin-bottom: 4px;
    }

    .mini-weekday {
        text-align: center;
        font-size: 11px;
        font-weight: 500;
        color: var(--neutral-foreground-hint);
        padding: 4px 0;
    }

    .mini-calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
    }

    .mini-day {
        aspect-ratio: 1;
        border: none;
        background: transparent;
        cursor: pointer;
        border-radius: 50%;
        font-size: 12px;
        color: var(--neutral-foreground-rest);
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .mini-day:hover {
        background: var(--neutral-fill-secondary-hover);
    }

    .mini-day.other-month {
        color: var(--neutral-foreground-hint);
    }

    .mini-day.today {
        background: var(--accent-fill-rest);
        color: var(--neutral-foreground-on-accent);
    }

    .mini-day.selected {
        background: var(--accent-fill-rest);
        color: var(--neutral-foreground-on-accent);
    }

    .mini-day.has-events {
        font-weight: 700;
    }

    /* Liste des agendas */
    .agenda-list {
        margin-bottom: 24px;
    }

    .agenda-list-title {
        margin-bottom: 8px;
        display: block;
    }

    .agenda-item {
        padding: 4px 0;
    }

    .agenda-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
    }

    .agenda-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        flex-shrink: 0;
    }

    .agenda-name {
        font-size: 14px;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Événements à venir */
    .upcoming-events {
        margin-top: 24px;
    }

    .upcoming-title {
        margin-bottom: 12px;
        display: block;
    }

    .upcoming-event {
        padding: 8px;
        margin-bottom: 4px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .upcoming-event:hover {
        background: var(--neutral-fill-secondary-hover);
    }

    .upcoming-event-time {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--neutral-foreground-hint);
        margin-bottom: 4px;
    }

    .event-color-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .upcoming-event-title {
        font-size: 14px;
        color: var(--neutral-foreground-rest);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .no-upcoming {
        font-size: 14px;
        color: var(--neutral-foreground-hint);
        padding: 8px;
    }

    /* Zone calendrier principale */
    .agenda-main {
        flex: 1;
        padding: 16px;
        overflow: auto;
        background: var(--neutral-layer-1);
    }

    .calendar-card {
        height: 100%;
        min-height: 600px;
        padding: 0;
    }

    #aion-agenda-calendar {
        height: 100%;
        padding: 16px;
    }

    /* Personnalisation FullCalendar */
    .fc {
        font-family: var(--body-font);
    }

    .fc-theme-standard .fc-scrollgrid {
        border-color: var(--neutral-stroke-divider-rest);
    }

    .fc-theme-standard td, .fc-theme-standard th {
        border-color: var(--neutral-stroke-divider-rest);
    }

    .fc .fc-button {
        background: var(--neutral-fill-rest);
        border-color: var(--neutral-stroke-control-rest);
        color: var(--neutral-foreground-rest);
    }

    .fc .fc-button:hover {
        background: var(--neutral-fill-hover);
    }

    .fc .fc-button-primary:not(:disabled).fc-button-active {
        background: var(--accent-fill-rest);
        border-color: var(--accent-fill-rest);
    }

    .fc-event {
        border-radius: 4px;
        padding: 2px 4px;
        font-size: 12px;
    }

    .fc-daygrid-event {
        margin: 1px 2px;
    }

    /* Dialog événement */
    .event-dialog {
        max-width: 720px;
    }

    .dialog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    .event-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .form-row {
        display: flex;
        align-items: flex-start;
        gap: 16px;
    }

    .form-icon {
        margin-top: 8px;
        color: var(--neutral-foreground-hint);
        flex-shrink: 0;
    }

    .title-input {
        flex: 1;
        font-size: 22px;
    }

    .datetime-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .datetime-row {
        display: flex;
        gap: 8px;
    }

    .full-width {
        width: 100%;
    }

    .options-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
    }

    .agenda-option {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .option-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }

    .reminders-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding-left: 36px;
    }

    .reminder-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .agenda-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        gap: 16px;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .agenda-sidebar {
            display: none;
        }
        
        .header-left {
            flex-wrap: wrap;
        }
        
        .current-period {
            font-size: 16px;
        }
    }
</style>

@code {
    
    // ... (Gardez tout le code C# existant exactement comme il est)
    private string? _currentView = "timeGridWeek";
    
    private readonly AgendaFormModel _formModel = new();
    private bool _enableReminders;
    private bool _loaded;
    private FluentDialog? _createEventDialog;
    private bool _isCreateDialogOpen;
    private string? _selectedAgendaId;
    private string? _selectedStatusId;
    private DateTime? _startDateLocal;
    private DateTime? _startTimeLocal;
    private DateTime? _endDateLocal;
    private DateTime? _endTimeLocal;

    private List<SAgenda> _agendas = new();
    private List<RAgendaEventStatus> _statuses = new();
    private List<RReminderChannel> _channels = new();
    private List<SAgendaEvent> _events = new();
    private readonly List<SAgendaReminder> _reminders = new();
    private DateTime _visibleRangeStartUtc = DateTime.UtcNow.Date.AddDays(-7);
    private DateTime _visibleRangeEndUtc = DateTime.UtcNow.Date.AddDays(30);
    private bool _calendarInitialized;
    private DateTime _miniCalendarDate = DateTime.Today;
    private DateTime _selectedDate = DateTime.Today;

    private IJSObjectReference? _agendaJsModule;
    private DotNetObjectReference<Agenda>? _dotNetRef;



    private bool CreateDialogHidden
    {
        get => !_isCreateDialogOpen;
        set => _isCreateDialogOpen = !value;
    }

    // Méthodes pour le mini calendrier
    private List<DateTime> GetMiniCalendarDays()
    {
        var firstDay = new DateTime(_miniCalendarDate.Year, _miniCalendarDate.Month, 1);
        var lastDay = firstDay.AddMonths(1).AddDays(-1);
        
        var startDay = firstDay.AddDays(-(int)firstDay.DayOfWeek + (int)DayOfWeek.Monday);
        if (startDay > firstDay) startDay = startDay.AddDays(-7);
        
        var endDay = lastDay.AddDays(7 - (int)lastDay.DayOfWeek);
        if (endDay < lastDay) endDay = endDay.AddDays(7);
        
        var days = new List<DateTime>();
        for (var day = startDay; day <= endDay; day = day.AddDays(1))
        {
            days.Add(day);
        }
        
        return days;
    }

    private string GetMiniDayClass(DateTime day)
    {
        var classes = new List<string>();
        
        if (day.Month != _miniCalendarDate.Month)
            classes.Add("other-month");
        
        if (day.Date == DateTime.Today)
            classes.Add("today");
        
        if (day.Date == _selectedDate.Date)
            classes.Add("selected");
        
        if (_events.Any(e => e.StartUtc.Date == day.Date))
            classes.Add("has-events");
        
        return string.Join(" ", classes);
    }

    private void SelectMiniDay(DateTime day)
    {
        _selectedDate = day;
        // Navigate calendar to this date if needed
    }

    private void PreviousMiniMonth()
    {
        _miniCalendarDate = _miniCalendarDate.AddMonths(-1);
    }

    private void NextMiniMonth()
    {
        _miniCalendarDate = _miniCalendarDate.AddMonths(1);
    }

    private string GetCurrentPeriodTitle()
    {
        return _miniCalendarDate.ToString("MMMM yyyy", new CultureInfo("fr-FR"));
    }

    private string GetAgendaColor(int agendaId)
    {
        var colors = new[] { "#1967D2", "#D81B60", "#E67C73", "#33B679", "#8E24AA", "#F4511E", "#039BE5", "#7CB342" };
        return colors[agendaId % colors.Length];
    }

    // Gardez toutes les méthodes existantes (OnInitializedAsync, OnAfterRenderAsync, LoadEventsAsync, etc.)
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        await using var db = await DbContextFactory.CreateDbContextAsync();

        var userId = UserContext.UserId;

        var ownedAgendas = await db.SAgendas
            .Where(a => a.OwnerUserId == userId && !a.Deleted)
            .AsNoTracking()
            .ToListAsync();

        var sharedIds = await db.SAgendaUsers
            .Where(x => x.UserId == userId && !x.Deleted)
            .Select(x => x.AgendaId)
            .ToListAsync();

        if (sharedIds.Count > 0)
        {
            var sharedAgendas = await db.SAgendas
                .Where(a => sharedIds.Contains(a.Id) && !a.Deleted)
                .AsNoTracking()
                .ToListAsync();

            ownedAgendas.AddRange(sharedAgendas);
        }

        _agendas = ownedAgendas
            .DistinctBy(a => a.Id)
            .OrderBy(a => a.Libelle)
            .ToList();

        _statuses = await db.RAgendaEventStatuses
            .AsNoTracking()
            .ToListAsync();

        _channels = await db.RReminderChannels
            .AsNoTracking()
            .ToListAsync();

        if (_agendas.Any())
        {
            _formModel.AgendaId = _agendas.First().Id;
        }

        if (_statuses.Any())
        {
            _formModel.StatusId = _statuses.First().Id;
        }

        _formModel.StartUtc = DateTime.UtcNow;
        _formModel.EndUtc = DateTime.UtcNow.AddHours(1);

        SyncFormStateFromModel();

        await LoadEventsAsync();

        _loaded = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_loaded && !_calendarInitialized)
        {
            _agendaJsModule ??= await JS.InvokeAsync<IJSObjectReference>("import", "/js/aionAgenda.js");
            _dotNetRef ??= DotNetObjectReference.Create(this);

            await _agendaJsModule.InvokeVoidAsync(
                "initCalendar",
                _dotNetRef,
                null,
                "timeGridWeek");

            _calendarInitialized = true;

            if (_events.Any())
            {
                var jsEvents = _events.Select(e => new
                {
                    id = e.Id.ToString(),
                    title = e.Libelle,
                    start = e.StartUtc,
                    end = e.EndUtc,
                    allDay = e.AllDay
                });

                await _agendaJsModule.InvokeVoidAsync("setEvents", jsEvents);
            }
        }
    }

    private async Task LoadEventsAsync()
    {
        if (!_agendas.Any())
        {
            _events = new List<SAgendaEvent>();
            return;
        }

        _events = await AgendaService.GetEventsForUserAsync(UserContext.UserId, _visibleRangeStartUtc, _visibleRangeEndUtc);
    }

    private void SyncFormStateFromModel()
    {
        _selectedAgendaId = _formModel.AgendaId == 0
            ? null
            : _formModel.AgendaId.ToString(CultureInfo.InvariantCulture);

        _selectedStatusId = _formModel.StatusId == 0
            ? null
            : _formModel.StatusId.ToString(CultureInfo.InvariantCulture);

        var startLocal = _formModel.StartUtc.ToLocalTime();
        _startDateLocal = startLocal.Date;
        _startTimeLocal = startLocal;

        var endLocal = _formModel.EndUtc.ToLocalTime();
        _endDateLocal = endLocal.Date;
        _endTimeLocal = endLocal;
    }

    private void UpdateModelFromLocalValues()
    {
        var startDate = _startDateLocal ?? _formModel.StartUtc.ToLocalTime().Date;
        var startTime = _startTimeLocal ?? _formModel.StartUtc.ToLocalTime();
        var startLocal = startDate.Date.Add(startTime.TimeOfDay);
        _formModel.StartUtc = DateTime.SpecifyKind(startLocal, DateTimeKind.Local).ToUniversalTime();

        var endDate = _endDateLocal ?? _formModel.EndUtc.ToLocalTime().Date;
        var endTime = _endTimeLocal ?? _formModel.EndUtc.ToLocalTime();
        var endLocal = endDate.Date.Add(endTime.TimeOfDay);
        _formModel.EndUtc = DateTime.SpecifyKind(endLocal, DateTimeKind.Local).ToUniversalTime();

        EnsureEndAfterStart();
        SyncFormStateFromModel();
    }

    private void EnsureEndAfterStart()
    {
        if (_formModel.EndUtc >= _formModel.StartUtc)
        {
            return;
        }

        _formModel.EndUtc = _formModel.AllDay
            ? _formModel.StartUtc.AddDays(1)
            : _formModel.StartUtc.AddHours(1);
    }

    private void OpenCreateDialog()
    {
        if (!_agendas.Any())
        {
            return;
        }

        SyncFormStateFromModel();
        _isCreateDialogOpen = true;
        StateHasChanged();
    }

    private void CloseCreateDialog()
    {
        _isCreateDialogOpen = false;
        StateHasChanged();
    }

    private void OnCreateDialogDismiss(DialogEventArgs args)
    {
        CloseCreateDialog();
    }

    private void OnAgendaChanged(string? value)
    {
        _selectedAgendaId = value;

        if (int.TryParse(value, NumberStyles.Integer, CultureInfo.InvariantCulture, out var id))
        {
            _formModel.AgendaId = id;
        }
    }

    private void OnStatusChanged(string? value)
    {
        _selectedStatusId = value;

        if (int.TryParse(value, NumberStyles.Integer, CultureInfo.InvariantCulture, out var id))
        {
            _formModel.StatusId = id;
        }
    }

    private void OnStartDateChanged(DateTime? value)
    {
        if (value is null)
        {
            return;
        }

        _startDateLocal = value.Value.Date;

        if (_endDateLocal.HasValue && _endDateLocal.Value.Date < _startDateLocal.Value.Date)
        {
            _endDateLocal = _startDateLocal;
        }

        UpdateModelFromLocalValues();
    }

    private void OnEndDateChanged(DateTime? value)
    {
        if (value is null)
        {
            return;
        }

        _endDateLocal = value.Value.Date;
        UpdateModelFromLocalValues();
    }

    private void OnStartTimeChanged(DateTime? value)
    {
        if (value is null)
        {
            return;
        }

        _startTimeLocal = value.Value;
        UpdateModelFromLocalValues();
    }

    private void OnEndTimeChanged(DateTime? value)
    {
        if (value is null)
        {
            return;
        }

        _endTimeLocal = value.Value;
        UpdateModelFromLocalValues();
    }

    private void OnAllDayChanged(bool value)
    {
        _formModel.AllDay = value;

        if (value)
        {
            _startTimeLocal = _startDateLocal;
            _endTimeLocal = _startDateLocal;
            _endDateLocal = _startDateLocal;
            UpdateModelFromLocalValues();
            _formModel.EndUtc = _formModel.StartUtc.AddDays(1);
            SyncFormStateFromModel();
        }
        else
        {
            UpdateModelFromLocalValues();
        }
    }

    private void OnReminderToggleChanged(bool value)
    {
        _enableReminders = value;

        if (!value)
        {
            _reminders.Clear();
        }

        StateHasChanged();
    }

    private void OnReminderOffsetChanged(SAgendaReminder reminder, int value)
    {
        reminder.OffsetMinutes = value;
    }

    private void OnReminderChannelChanged(SAgendaReminder reminder, string? value)
    {
        if (int.TryParse(value, NumberStyles.Integer, CultureInfo.InvariantCulture, out var id))
        {
            reminder.ChannelId = id;
        }
    }

    [JSInvokable]
    public async Task OnVisibleRangeChangedAsync(string startStr, string endStr)
    {
        if (DateTime.TryParse(startStr, CultureInfo.InvariantCulture, DateTimeStyles.AssumeUniversal | DateTimeStyles.AdjustToUniversal, out var rangeStartUtc))
        {
            _visibleRangeStartUtc = rangeStartUtc;
        }

        if (DateTime.TryParse(endStr, CultureInfo.InvariantCulture, DateTimeStyles.AssumeUniversal | DateTimeStyles.AdjustToUniversal, out var rangeEndUtc))
        {
            _visibleRangeEndUtc = rangeEndUtc;
        }

        await LoadEventsAsync();

        if (_agendaJsModule is null)
            return;

        var jsEvents = _events.Select(e => new
        {
            id = e.Id.ToString(),
            title = e.Libelle,
            start = e.StartUtc,
            end = e.EndUtc,
            allDay = e.AllDay,
            backgroundColor = GetAgendaColor(e.AgendaId),
            borderColor = GetAgendaColor(e.AgendaId)
        });

        await _agendaJsModule.InvokeVoidAsync("setEvents", jsEvents);
        StateHasChanged();
    }

    [JSInvokable]
    public Task OnEventCreatedAsync(string startStr, string endStr, bool allDay)
    {
        if (DateTime.TryParse(startStr, out var start))
        {
            _formModel.StartUtc = DateTime.SpecifyKind(start, DateTimeKind.Utc);
        }

        if (DateTime.TryParse(endStr, out var end))
        {
            _formModel.EndUtc = DateTime.SpecifyKind(end, DateTimeKind.Utc);
        }

        _formModel.AllDay = allDay;
        _enableReminders = false;
        _reminders.Clear();

        SyncFormStateFromModel();
        OpenCreateDialog();
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnEventClickAsync(string eventId)
    {
        // TODO: Ouvrir dialog d'édition
        return Task.CompletedTask;
    }

    private void AddReminder()
    {
        _enableReminders = true;
        var defaultChannel = _channels.FirstOrDefault();

        _reminders.Add(new SAgendaReminder
        {
            OffsetMinutes = -15,
            ChannelId = defaultChannel?.Id ?? 1,
            TriggerAtUtc = _formModel.StartUtc.AddMinutes(-15),
            TenantId = UserContext.TenantId,
            Actif = true
        });

        StateHasChanged();
    }

    private void RemoveReminder(SAgendaReminder reminder)
    {
        _reminders.Remove(reminder);

        if (_reminders.Count == 0)
        {
            _enableReminders = false;
        }

        StateHasChanged();
    }

    private void NormalizeReminder(SAgendaReminder reminder)
    {
        reminder.OffsetMinutes = reminder.OffsetMinutes <= 0
            ? reminder.OffsetMinutes
            : -reminder.OffsetMinutes;

        reminder.TriggerAtUtc = _formModel.StartUtc.AddMinutes(reminder.OffsetMinutes);
    }

    private async Task CreateEventAsync(EditContext _)
    {
        UpdateModelFromLocalValues();

        _formModel.TenantId = UserContext.TenantId;
        _formModel.Actif = true;
        _formModel.EnableReminders = _enableReminders && _reminders.Count > 0;

        foreach (var reminder in _reminders)
        {
            NormalizeReminder(reminder);
            reminder.TenantId = UserContext.TenantId;
            reminder.Actif = true;
        }

        var evt = _formModel.ToEntity();

        await AgendaService.CreateEventAsync(
            evt,
            _enableReminders ? _reminders.ToList() : null);

        var nextStartUtc = DateTime.UtcNow;

        _formModel.Libelle = string.Empty;
        _formModel.Description = string.Empty;
        _formModel.AllDay = false;
        _formModel.IsPrivate = false;
        _enableReminders = false;
        _reminders.Clear();
        _formModel.EnableReminders = false;

        _formModel.StartUtc = nextStartUtc;
        _formModel.EndUtc = nextStartUtc.AddHours(1);

        await LoadEventsAsync();

        if (_agendaJsModule is not null)
        {
            var jsEvents = _events.Select(e => new
            {
                id = e.Id.ToString(),
                title = e.Libelle,
                start = e.StartUtc,
                end = e.EndUtc,
                allDay = e.AllDay,
                backgroundColor = GetAgendaColor(e.AgendaId),
                borderColor = GetAgendaColor(e.AgendaId)
            });

            await _agendaJsModule.InvokeVoidAsync("setEvents", jsEvents);
        }

        SyncFormStateFromModel();
        _isCreateDialogOpen = false;

        StateHasChanged();
    }

    private async Task GoToday()
    {
        if (_agendaJsModule is not null)
        {
            await _agendaJsModule.InvokeVoidAsync("goToday");
        }
    }

    private async Task GoPrev()
    {
        if (_agendaJsModule is not null)
        {
            await _agendaJsModule.InvokeVoidAsync("goPrev");
        }
    }

    private async Task GoNext()
    {
        if (_agendaJsModule is not null)
        {
            await _agendaJsModule.InvokeVoidAsync("goNext");
        }
    }

    private async Task ChangeView(string viewName)
    {
        if (_agendaJsModule is not null)
        {
            await _agendaJsModule.InvokeVoidAsync("changeView", viewName);
        }
    }

    private sealed class AgendaFormModel : SAgendaEvent
    {
        public AgendaFormModel()
        {
            EnableReminders = false;
        }

        public SAgendaEvent ToEntity()
        {
            return new SAgendaEvent
            {
                AgendaId = AgendaId,
                Libelle = Libelle,
                Description = Description,
                StartUtc = StartUtc,
                EndUtc = EndUtc,
                AllDay = AllDay,
                IsPrivate = IsPrivate,
                StatusId = StatusId,
                ContextEntityType = ContextEntityType,
                ContextEntityId = ContextEntityId,
                EnableReminders = EnableReminders,
                TenantId = TenantId,
                Actif = Actif,
                Doc = Doc,
                Deleted = Deleted
            };
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_agendaJsModule is not null)
        {
            try
            {
                await _agendaJsModule.InvokeVoidAsync("disposeCalendar");
            }
            catch (JSDisconnectedException)
            {
            }
            catch (ObjectDisposedException)
            {
            }

            await _agendaJsModule.DisposeAsync();
            _agendaJsModule = null;
        }

        _dotNetRef?.Dispose();
        _dotNetRef = null;
        _calendarInitialized = false;
    }
}
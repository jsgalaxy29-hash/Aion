@page "/agenda"
@using Aion.DataEngine.Interfaces
@using Aion.Infrastructure
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.JSInterop
@using System.Globalization
@using System.Linq
@using Aion.Domain.Agenda
@inject IAgendaService AgendaService
@inject IUserContext UserContext
@inject IDbContextFactory<AionDbContext> DbContextFactory
@inject IJSRuntime JS
@attribute [Authorize]

<FluentLabel Typo="Typography.H2">Agenda</FluentLabel>

@if (!_loaded)
{
    <FluentStack Orientation="Orientation.Horizontal" Gap="8">
        <FluentProgressRing />
        <FluentLabel>Chargement des agendas...</FluentLabel>
    </FluentStack>
}
else if (!_agendas.Any())
{
    <FluentMessageBar Intent="MessageIntent.Warning">
        Aucun agenda disponible pour cet utilisateur.
    </FluentMessageBar>
}
else
{
    <div class="agenda-layout">
        <div class="agenda-main">
            <div class="agenda-toolbar">
                <FluentStack Orientation="Orientation.Horizontal"
                             Gap="8"
                             AlignItems="AlignItems.Center">
                    <FluentButton Appearance="Appearance.Stealth" Icon="CalendarToday24Regular" OnClick="GoToday">Aujourd'hui</FluentButton>
                    <FluentButton Appearance="Appearance.Stealth" Icon="ArrowLeft24Regular" OnClick="GoPrev">Précédent</FluentButton>
                    <FluentButton Appearance="Appearance.Stealth" Icon="ArrowRight24Regular" OnClick="GoNext">Suivant</FluentButton>

                    <FluentDivider Orientation="Orientation.Vertical" />

                    <FluentButton Appearance="Appearance.Stealth" OnClick="@(() => ChangeView("dayGridMonth"))">Mois</FluentButton>
                    <FluentButton Appearance="Appearance.Stealth" OnClick="@(() => ChangeView("timeGridWeek"))">Semaine</FluentButton>
                    <FluentButton Appearance="Appearance.Stealth" OnClick="@(() => ChangeView("timeGridDay"))">Jour</FluentButton>
                </FluentStack>

                <FluentStack Orientation="Orientation.Horizontal" Gap="8" AlignItems="AlignItems.Center">
                    <FluentButton Appearance="Appearance.Accent"
                                   Icon="Add24Regular"
                                   OnClick="OpenCreateDialog">
                        Nouvel événement
                    </FluentButton>
                </FluentStack>
            </div>

            <FluentCard Class="agenda-calendar-card">
                <div id="aion-agenda-calendar"></div>
            </FluentCard>
        </div>

        <div class="agenda-sidebar">
            <FluentCard Class="agenda-card agenda-upcoming-card">
                <FluentStack Orientation="Orientation.Vertical" Gap="12">
                    <FluentStack Orientation="Orientation.Horizontal"
                                 AlignItems="AlignItems.Center"
                                 JustifyContent="JustifyContent.SpaceBetween">
                        <FluentLabel Typo="Typography.H5">À venir</FluentLabel>
                        <FluentBadge Appearance="BadgeAppearance.Tint">
                            @_events.Count(e => e.StartUtc >= DateTime.UtcNow)
                        </FluentBadge>
                    </FluentStack>

                    @if (!_events.Any())
                    {
                        <FluentMessageBar Intent="MessageIntent.Info">
                            Aucun événement planifié.
                        </FluentMessageBar>
                    }
                    else
                    {
                        <div class="agenda-upcoming">
                            @foreach (var evt in _events.OrderBy(e => e.StartUtc).Take(8))
                            {
                                var agenda = _agendas.FirstOrDefault(a => a.Id == evt.AgendaId);
                                var status = _statuses.FirstOrDefault(s => s.Id == evt.StatusId);

                                <div class="agenda-upcoming-item">
                                    <div class="agenda-upcoming-title">@evt.Libelle</div>
                                    <div class="agenda-upcoming-meta">
                                        <span>@agenda?.Libelle</span>
                                        <span>@evt.StartUtc.ToLocalTime():g</span>
                                        @if (evt.EndUtc != default)
                                        {
                                            <span>→ @evt.EndUtc.ToLocalTime():t</span>
                                        }
                                        <span>@status?.Libelle</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </FluentStack>
            </FluentCard>
        </div>
    </div>

    <FluentDialog @ref="_createEventDialog"
                  @bind-Hidden="CreateDialogHidden"
                  Style="max-width: 640px;"
                  Modal="true"
                  TrapFocus="true"
                  @ondialogdismiss="OnCreateDialogDismiss">
        <FluentDialogHeader>
            <FluentStack Orientation="Orientation.Horizontal"
                         AlignItems="AlignItems.Center"
                         JustifyContent="JustifyContent.SpaceBetween">
                <FluentLabel Typo="Typography.H4">Nouvel événement</FluentLabel>
                <FluentButton Appearance="Appearance.Stealth" Icon="Dismiss24Regular" OnClick="CloseCreateDialog" />
            </FluentStack>
        </FluentDialogHeader>

        <FluentDialogBody>
            <div class="agenda-dialog-body">
                <EditForm Model="_formModel" OnValidSubmit="CreateEventAsync" Id="agenda-create-form">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <FluentStack Orientation="Orientation.Vertical" Gap="12">
                        <FluentStack Orientation="Orientation.Vertical" Gap="4">
                            <FluentLabel>Agenda</FluentLabel>
                            <FluentSelect TOption="string"
                                          Value="@_selectedAgendaId"
                                          ValueChanged="OnAgendaChanged"
                                          Style="min-width: 100%">
                                @foreach (var agenda in _agendas)
                                {
                                    <FluentOption Value="@agenda.Id.ToString()">@agenda.Libelle</FluentOption>
                                }
                            </FluentSelect>
                        </FluentStack>

                        <FluentStack Orientation="Orientation.Vertical" Gap="4">
                            <FluentLabel>Titre</FluentLabel>
                            <FluentTextField @bind-Value="_formModel.Libelle"
                                             Placeholder="Titre de l'événement" />
                        </FluentStack>

                        <FluentStack Orientation="Orientation.Vertical" Gap="4">
                            <FluentLabel>Description</FluentLabel>
                            <FluentTextArea @bind-Value="_formModel.Description"
                                           Rows="3"
                                           Placeholder="Détails ou description" />
                        </FluentStack>

                        <div class="agenda-datetime-grid">
                            <FluentStack Orientation="Orientation.Vertical" Gap="4">
                                <FluentLabel>Début</FluentLabel>
                                <FluentDatePicker Value="@_startDateLocal"
                                                  ValueChanged="OnStartDateChanged"
                                                  Placeholder="Date de début" />
                                <FluentTimePicker Value="@_startTimeLocal"
                                                  ValueChanged="OnStartTimeChanged" />
                            </FluentStack>

                            <FluentStack Orientation="Orientation.Vertical" Gap="4">
                                <FluentLabel>Fin</FluentLabel>
                                <FluentDatePicker Value="@_endDateLocal"
                                                  ValueChanged="OnEndDateChanged"
                                                  Placeholder="Date de fin" />
                                <FluentTimePicker Value="@_endTimeLocal"
                                                  ValueChanged="OnEndTimeChanged" />
                            </FluentStack>
                        </div>

                        <FluentStack Orientation="Orientation.Vertical" Gap="4">
                            <FluentLabel>Statut</FluentLabel>
                            <FluentSelect TOption="string"
                                          Value="@_selectedStatusId"
                                          ValueChanged="OnStatusChanged">
                                @foreach (var status in _statuses)
                                {
                                    <FluentOption Value="@status.Id.ToString()">@status.Libelle</FluentOption>
                                }
                            </FluentSelect>
                        </FluentStack>

                        <FluentStack Orientation="Orientation.Vertical" Gap="8">
                            <FluentStack Orientation="Orientation.Horizontal" Gap="8">
                                <FluentCheckbox @bind-Value="_formModel.AllDay" OnChange="OnAllDayChanged">Journée entière</FluentCheckbox>
                                <FluentCheckbox @bind-Value="_formModel.IsPrivate">Privé</FluentCheckbox>
                                <FluentCheckbox @bind-Value="_enableReminders" OnChange="OnReminderToggleChanged">Activer les rappels</FluentCheckbox>
                            </FluentStack>

                            @if (_enableReminders)
                            {
                                <FluentStack Orientation="Orientation.Vertical" Gap="8" Class="agenda-reminder-group">
                                    @if (!_reminders.Any())
                                    {
                                        <FluentMessageBar Intent="MessageIntent.Info">Aucun rappel défini.</FluentMessageBar>
                                    }

                                    @foreach (var reminder in _reminders)
                                    {
                                        <FluentStack Orientation="Orientation.Horizontal" Gap="8" AlignItems="AlignItems.Center" Class="agenda-reminder-row">
                                            <FluentNumberField TValue="int"
                                                               Value="@reminder.OffsetMinutes"
                                                               ValueChanged="@((int value) => OnReminderOffsetChanged(reminder, value))"
                                                               Style="width: 100px;" />
                                            <FluentLabel>minutes avant</FluentLabel>
                                            <FluentSelect TOption="string"
                                                          Value="@reminder.ChannelId.ToString()"
                                                          ValueChanged="@((string? value) => OnReminderChannelChanged(reminder, value))"
                                                          Style="min-width: 160px;">
                                                @foreach (var ch in _channels)
                                                {
                                                    <FluentOption Value="@ch.Id.ToString()">@ch.Libelle</FluentOption>
                                                }
                                            </FluentSelect>
                                            <FluentButton Appearance="Appearance.Stealth"
                                                           Icon="Delete16Regular"
                                                           OnClick="@(() => RemoveReminder(reminder))" />
                                        </FluentStack>
                                    }

                                    <FluentButton Appearance="Appearance.Stealth"
                                                   Icon="Add16Regular"
                                                   OnClick="AddReminder">
                                        Ajouter un rappel
                                    </FluentButton>
                                </FluentStack>
                            }
                        </FluentStack>
                    </FluentStack>
                </EditForm>
            </div>
        </FluentDialogBody>

        <FluentDialogFooter>
            <FluentStack Orientation="Orientation.Horizontal" Gap="8">
                <FluentButton Appearance="Appearance.Accent" Type="ButtonType.Submit" Form="agenda-create-form">
                    Enregistrer
                </FluentButton>
                <FluentButton Appearance="Appearance.Stealth" OnClick="CloseCreateDialog">Annuler</FluentButton>
            </FluentStack>
        </FluentDialogFooter>
    </FluentDialog>
}

@implements IAsyncDisposable

@code {
    private readonly AgendaFormModel _formModel = new();
    private bool _enableReminders;
    private bool _loaded;
    private FluentDialog? _createEventDialog;
    private bool _isCreateDialogOpen;
    private string? _selectedAgendaId;
    private string? _selectedStatusId;
    private DateTime? _startDateLocal;
    private TimeSpan? _startTimeLocal;
    private DateTime? _endDateLocal;
    private TimeSpan? _endTimeLocal;

    private List<SAgenda> _agendas = new();
    private List<RAgendaEventStatus> _statuses = new();
    private List<RReminderChannel> _channels = new();
    private List<SAgendaEvent> _events = new();
    private readonly List<SAgendaReminder> _reminders = new();
    private DateTime _visibleRangeStartUtc = DateTime.UtcNow.Date.AddDays(-7);
    private DateTime _visibleRangeEndUtc = DateTime.UtcNow.Date.AddDays(30);
    private bool _calendarInitialized;

    // JS interop
    private IJSObjectReference? _agendaJsModule;
    private DotNetObjectReference<Agenda>? _dotNetRef;

    private bool CreateDialogHidden
    {
        get => !_isCreateDialogOpen;
        set => _isCreateDialogOpen = !value;
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        await using var db = await DbContextFactory.CreateDbContextAsync();

        var userId = UserContext.UserId;

        // Agendas possédés
        var ownedAgendas = await db.SAgendas
            .Where(a => a.OwnerUserId == userId && !a.Deleted)
            .AsNoTracking()
            .ToListAsync();

        // Agendas partagés
        var sharedIds = await db.SAgendaUsers
            .Where(x => x.UserId == userId && !x.Deleted)
            .Select(x => x.AgendaId)
            .ToListAsync();

        if (sharedIds.Count > 0)
        {
            var sharedAgendas = await db.SAgendas
                .Where(a => sharedIds.Contains(a.Id) && !a.Deleted)
                .AsNoTracking()
                .ToListAsync();

            ownedAgendas.AddRange(sharedAgendas);
        }

        _agendas = ownedAgendas
            .DistinctBy(a => a.Id)
            .OrderBy(a => a.Libelle)
            .ToList();

        _statuses = await db.RAgendaEventStatuses
            .AsNoTracking()
            .ToListAsync();

        _channels = await db.RReminderChannels
            .AsNoTracking()
            .ToListAsync();

        if (_agendas.Any())
        {
            _formModel.AgendaId = _agendas.First().Id;
        }

        if (_statuses.Any())
        {
            _formModel.StatusId = _statuses.First().Id;
        }

        _formModel.StartUtc = DateTime.UtcNow;
        _formModel.EndUtc = DateTime.UtcNow.AddHours(1);

        SyncFormStateFromModel();

        await LoadEventsAsync();

        _loaded = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_loaded && !_calendarInitialized)
        {
            _agendaJsModule ??= await JS.InvokeAsync<IJSObjectReference>("import", "/js/aionAgenda.js");
            _dotNetRef ??= DotNetObjectReference.Create(this);

            // initCalendar(dotNetRef, selectedAgendaId, defaultView)
            await _agendaJsModule.InvokeVoidAsync(
                "initCalendar",
                _dotNetRef,
                null,
                "timeGridWeek");

            _calendarInitialized = true;

            if (_events.Any())
            {
                var jsEvents = _events.Select(e => new
                {
                    id = e.Id.ToString(),
                    title = e.Libelle,
                    start = e.StartUtc,
                    end = e.EndUtc,
                    allDay = e.AllDay
                });

                await _agendaJsModule.InvokeVoidAsync("setEvents", jsEvents);
            }

            // Le premier datesSet côté JS rappellera OnVisibleRangeChangedAsync, qui chargera les events.
        }
    }

    private async Task LoadEventsAsync()
    {
        if (!_agendas.Any())
        {
            _events = new List<SAgendaEvent>();
            return;
        }

        _events = await AgendaService.GetEventsForUserAsync(UserContext.UserId, _visibleRangeStartUtc, _visibleRangeEndUtc);
    }

    private void SyncFormStateFromModel()
    {
        _selectedAgendaId = _formModel.AgendaId == 0
            ? null
            : _formModel.AgendaId.ToString(CultureInfo.InvariantCulture);

        _selectedStatusId = _formModel.StatusId == 0
            ? null
            : _formModel.StatusId.ToString(CultureInfo.InvariantCulture);

        var startLocal = _formModel.StartUtc.ToLocalTime();
        _startDateLocal = startLocal.Date;
        _startTimeLocal = startLocal.TimeOfDay;

        var endLocal = _formModel.EndUtc.ToLocalTime();
        _endDateLocal = endLocal.Date;
        _endTimeLocal = endLocal.TimeOfDay;
    }

    private void UpdateModelFromLocalValues()
    {
        var startDate = _startDateLocal ?? _formModel.StartUtc.ToLocalTime().Date;
        var startTime = _startTimeLocal ?? _formModel.StartUtc.ToLocalTime().TimeOfDay;
        var startLocal = startDate.Date + startTime;
        _formModel.StartUtc = DateTime.SpecifyKind(startLocal, DateTimeKind.Local).ToUniversalTime();

        var endDate = _endDateLocal ?? _formModel.EndUtc.ToLocalTime().Date;
        var endTime = _endTimeLocal ?? _formModel.EndUtc.ToLocalTime().TimeOfDay;
        var endLocal = endDate.Date + endTime;
        _formModel.EndUtc = DateTime.SpecifyKind(endLocal, DateTimeKind.Local).ToUniversalTime();

        EnsureEndAfterStart();
        SyncFormStateFromModel();
    }

    private void EnsureEndAfterStart()
    {
        if (_formModel.EndUtc >= _formModel.StartUtc)
        {
            return;
        }

        _formModel.EndUtc = _formModel.AllDay
            ? _formModel.StartUtc.AddDays(1)
            : _formModel.StartUtc.AddHours(1);
    }

    private void OpenCreateDialog()
    {
        if (!_agendas.Any())
        {
            return;
        }

        SyncFormStateFromModel();
        _isCreateDialogOpen = true;
        StateHasChanged();
    }

    private void CloseCreateDialog()
    {
        _isCreateDialogOpen = false;
        StateHasChanged();
    }

    private void OnCreateDialogDismiss(DialogEventArgs args)
    {
        CloseCreateDialog();
    }

    private void OnAgendaChanged(string? value)
    {
        _selectedAgendaId = value;

        if (int.TryParse(value, NumberStyles.Integer, CultureInfo.InvariantCulture, out var id))
        {
            _formModel.AgendaId = id;
        }
    }

    private void OnStatusChanged(string? value)
    {
        _selectedStatusId = value;

        if (int.TryParse(value, NumberStyles.Integer, CultureInfo.InvariantCulture, out var id))
        {
            _formModel.StatusId = id;
        }
    }

    private void OnStartDateChanged(DateTime? value)
    {
        if (value is null)
        {
            return;
        }

        _startDateLocal = value.Value.Date;

        if (_endDateLocal.HasValue && _endDateLocal.Value.Date < _startDateLocal.Value.Date)
        {
            _endDateLocal = _startDateLocal;
        }

        UpdateModelFromLocalValues();
    }

    private void OnEndDateChanged(DateTime? value)
    {
        if (value is null)
        {
            return;
        }

        _endDateLocal = value.Value.Date;
        UpdateModelFromLocalValues();
    }

    private void OnStartTimeChanged(TimeSpan? value)
    {
        if (value is null)
        {
            return;
        }

        _startTimeLocal = value.Value;
        UpdateModelFromLocalValues();
    }

    private void OnEndTimeChanged(TimeSpan? value)
    {
        if (value is null)
        {
            return;
        }

        _endTimeLocal = value.Value;
        UpdateModelFromLocalValues();
    }

    private void OnAllDayChanged(bool value)
    {
        _formModel.AllDay = value;

        if (value)
        {
            _startTimeLocal = TimeSpan.Zero;
            _endTimeLocal = TimeSpan.Zero;
            _endDateLocal = _startDateLocal;
            UpdateModelFromLocalValues();
            _formModel.EndUtc = _formModel.StartUtc.AddDays(1);
            SyncFormStateFromModel();
        }
        else
        {
            UpdateModelFromLocalValues();
        }
    }

    private void OnReminderToggleChanged(bool value)
    {
        _enableReminders = value;

        if (!value)
        {
            _reminders.Clear();
        }

        StateHasChanged();
    }

    private void OnReminderOffsetChanged(SAgendaReminder reminder, int value)
    {
        reminder.OffsetMinutes = value;
    }

    private void OnReminderChannelChanged(SAgendaReminder reminder, string? value)
    {
        if (int.TryParse(value, NumberStyles.Integer, CultureInfo.InvariantCulture, out var id))
        {
            reminder.ChannelId = id;
        }
    }

    [JSInvokable]
    public async Task OnVisibleRangeChangedAsync(string startStr, string endStr)
    {
        if (DateTime.TryParse(startStr, CultureInfo.InvariantCulture, DateTimeStyles.AssumeUniversal | DateTimeStyles.AdjustToUniversal, out var rangeStartUtc))
        {
            _visibleRangeStartUtc = rangeStartUtc;
        }

        if (DateTime.TryParse(endStr, CultureInfo.InvariantCulture, DateTimeStyles.AssumeUniversal | DateTimeStyles.AdjustToUniversal, out var rangeEndUtc))
        {
            _visibleRangeEndUtc = rangeEndUtc;
        }

        await LoadEventsAsync();

        if (_agendaJsModule is null)
            return;

        // Projection des événements au format attendu par FullCalendar
        var jsEvents = _events.Select(e => new
        {
            id = e.Id.ToString(),
            title = e.Libelle,
            start = e.StartUtc,
            end = e.EndUtc,
            allDay = e.AllDay
        });

        await _agendaJsModule.InvokeVoidAsync("setEvents", jsEvents);
        StateHasChanged();
    }

    [JSInvokable]
    public Task OnEventCreatedAsync(string startStr, string endStr, bool allDay)
    {
        if (DateTime.TryParse(startStr, out var start))
        {
            _formModel.StartUtc = DateTime.SpecifyKind(start, DateTimeKind.Utc);
        }

        if (DateTime.TryParse(endStr, out var end))
        {
            _formModel.EndUtc = DateTime.SpecifyKind(end, DateTimeKind.Utc);
        }

        _formModel.AllDay = allDay;
        _enableReminders = false;
        _reminders.Clear();

        SyncFormStateFromModel();
        OpenCreateDialog();
        return Task.CompletedTask;
    }

    // Pour l’instant, on ne fait rien de spécial sur le clic d’événement
    [JSInvokable]
    public Task OnEventClickAsync(string eventId)
    {
        // Si plus tard tu veux remplir _formModel pour éditer : il faudra adapter ici
        return Task.CompletedTask;
    }

    private void AddReminder()
    {
        _enableReminders = true;
        var defaultChannel = _channels.FirstOrDefault();

        _reminders.Add(new SAgendaReminder
        {
            OffsetMinutes = -15,
            ChannelId = defaultChannel?.Id ?? 1,
            TriggerAtUtc = _formModel.StartUtc.AddMinutes(-15),
            TenantId = UserContext.TenantId,
            Actif = true
        });

        StateHasChanged();
    }

    private void RemoveReminder(SAgendaReminder reminder)
    {
        _reminders.Remove(reminder);

        if (_reminders.Count == 0)
        {
            _enableReminders = false;
        }

        StateHasChanged();
    }

    private void NormalizeReminder(SAgendaReminder reminder)
    {
        reminder.OffsetMinutes = reminder.OffsetMinutes <= 0
            ? reminder.OffsetMinutes
            : -reminder.OffsetMinutes;

        reminder.TriggerAtUtc = _formModel.StartUtc.AddMinutes(reminder.OffsetMinutes);
    }

    private async Task CreateEventAsync(EditContext _)
    {
        UpdateModelFromLocalValues();

        _formModel.TenantId = UserContext.TenantId;
        _formModel.Actif = true;
        _formModel.EnableReminders = _enableReminders && _reminders.Count > 0;

        foreach (var reminder in _reminders)
        {
            NormalizeReminder(reminder);
            reminder.TenantId = UserContext.TenantId;
            reminder.Actif = true;
        }

        var evt = _formModel.ToEntity();

        await AgendaService.CreateEventAsync(
            evt,
            _enableReminders ? _reminders.ToList() : null);

        var nextStartUtc = DateTime.UtcNow;

        _formModel.Libelle = string.Empty;
        _formModel.Description = string.Empty;
        _formModel.AllDay = false;
        _formModel.IsPrivate = false;
        _enableReminders = false;
        _reminders.Clear();
        _formModel.EnableReminders = false;

        _formModel.StartUtc = nextStartUtc;
        _formModel.EndUtc = nextStartUtc.AddHours(1);

        await LoadEventsAsync();

        // On rafraîchit aussi FullCalendar
        if (_agendaJsModule is not null)
        {
            var jsEvents = _events.Select(e => new
            {
                id = e.Id.ToString(),
                title = e.Libelle,
                start = e.StartUtc,
                end = e.EndUtc,
                allDay = e.AllDay
            });

            await _agendaJsModule.InvokeVoidAsync("setEvents", jsEvents);
        }

        SyncFormStateFromModel();
        _isCreateDialogOpen = false;

        StateHasChanged();
    }

    private async Task GoToday()
    {
        if (_agendaJsModule is not null)
        {
            await _agendaJsModule.InvokeVoidAsync("goToday");
        }
    }

    private async Task GoPrev()
    {
        if (_agendaJsModule is not null)
        {
            await _agendaJsModule.InvokeVoidAsync("goPrev");
        }
    }

    private async Task GoNext()
    {
        if (_agendaJsModule is not null)
        {
            await _agendaJsModule.InvokeVoidAsync("goNext");
        }
    }

    private async Task ChangeView(string viewName)
    {
        if (_agendaJsModule is not null)
        {
            await _agendaJsModule.InvokeVoidAsync("changeView", viewName);
        }
    }

    private sealed class AgendaFormModel : SAgendaEvent
    {
        public AgendaFormModel()
        {
            EnableReminders = false;
        }

        public SAgendaEvent ToEntity()
        {
            return new SAgendaEvent
            {
                AgendaId = AgendaId,
                Libelle = Libelle,
                Description = Description,
                StartUtc = StartUtc,
                EndUtc = EndUtc,
                AllDay = AllDay,
                IsPrivate = IsPrivate,
                StatusId = StatusId,
                ContextEntityType = ContextEntityType,
                ContextEntityId = ContextEntityId,
                EnableReminders = EnableReminders,
                TenantId = TenantId,
                Actif = Actif,
                Doc = Doc,
                Deleted = Deleted
            };
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_agendaJsModule is not null)
        {
            try
            {
                await _agendaJsModule.InvokeVoidAsync("disposeCalendar");
            }
            catch (JSDisconnectedException)
            {
                // Ignored: the circuit is gone.
            }
            catch (ObjectDisposedException)
            {
                // Module already disposed.
            }

            await _agendaJsModule.DisposeAsync();
            _agendaJsModule = null;
        }

        _dotNetRef?.Dispose();
        _dotNetRef = null;
        _calendarInitialized = false;
    }
}

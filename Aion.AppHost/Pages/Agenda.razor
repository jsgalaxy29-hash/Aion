@page "/agenda"
@using System.ComponentModel.DataAnnotations
@using System.Globalization
@using System.Linq
@using System.Threading.Tasks
@using Aion.DataEngine.Interfaces
@using Aion.Infrastructure
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.EntityFrameworkCore
@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.JSInterop
@using Aion.Domain.Agenda
@inject IAgendaService AgendaService
@inject IUserContext UserContext
@inject IDbContextFactory<AionDbContext> DbContextFactory
@inject IJSRuntime JsRuntime
@attribute [Authorize]
@implements IAsyncDisposable

<PageTitle>Agenda</PageTitle>

<FluentLabel Typo="Typography.H2" Class="mb-3">Agenda</FluentLabel>

@if (_errorMessage is not null)
{
    <FluentMessageBar Intent="MessageIntent.Error" Class="mb-3">
        @_errorMessage
    </FluentMessageBar>
}

@if (!_loaded)
{
    <FluentProgressRing />
}
else if (!_agendas.Any())
{
    <FluentMessageBar Intent="MessageIntent.Warning">
        Aucun agenda disponible pour votre compte.
    </FluentMessageBar>
}
else
{
    <div class="agenda-layout">
        <div class="agenda-sidebar">
            <FluentCard Class="agenda-sidebar-card">
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                    <FluentLabel Typo="Typography.H5">Agendas</FluentLabel>

                    <FluentRadioGroup Value="@_selectedAgendaKey"
                                      ValueChanged="@((string? value) => OnAgendaChangedAsync(value))"
                                      Orientation="Orientation.Vertical">
                        @foreach (var agenda in _agendas)
                        {
                            <FluentRadio Value="@agenda.Id.ToString()">
                                @agenda.Libelle
                            </FluentRadio>
                        }
                    </FluentRadioGroup>

                    <FluentButton Appearance="Appearance.Accent" OnClick="@OpenCreateDialogAsync">
                        ➕ Nouvel événement
                    </FluentButton>
                </FluentStack>
            </FluentCard>

            <FluentCard Class="agenda-sidebar-card">
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                    <FluentLabel Typo="Typography.H6">Prochains événements</FluentLabel>
                    @if (!UpcomingEvents.Any())
                    {
                        <FluentLabel>Pas d'événement planifié.</FluentLabel>
                    }
                    else
                    {
                        @foreach (var evt in UpcomingEvents)
                        {
                            <FluentStack Orientation="Orientation.Vertical" Class="agenda-upcoming-item">
                                <FluentLabel Typo="Typography.Body">@evt.Libelle</FluentLabel>
                                <FluentLabel Typo="Typography.Body">@evt.StartUtc.ToLocalTime().ToString("g")</FluentLabel>
                            </FluentStack>
                        }
                    }
                </FluentStack>
            </FluentCard>
        </div>

        <div class="agenda-main">
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8" Wrap="true">
                    <FluentButton Appearance="Appearance.Stealth" OnClick="@GoPrevAsync">◀</FluentButton>
                    <FluentButton Appearance="Appearance.Stealth" OnClick="@GoTodayAsync">Aujourd'hui</FluentButton>
                    <FluentButton Appearance="Appearance.Stealth" OnClick="@GoNextAsync">▶</FluentButton>

                    <FluentDivider Orientation="Orientation.Vertical" />

                    <FluentButton Appearance="@GetViewAppearance("dayGridMonth")" OnClick="@ShowMonthViewAsync">Mois</FluentButton>
                    <FluentButton Appearance="@GetViewAppearance("timeGridWeek")" OnClick="@ShowWeekViewAsync">Semaine</FluentButton>
                    <FluentButton Appearance="@GetViewAppearance("timeGridDay")" OnClick="@ShowDayViewAsync">Jour</FluentButton>
                </FluentStack>

                <div id="aion-agenda-calendar" class="agenda-calendar"></div>
            </FluentStack>
        </div>
    </div>
}

<FluentDialog @bind-Hidden="_dialogHidden"
              Modal="true"
              TrapFocus="true"
              Style="min-width: 420px;">

    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H4">@(_formModel.IsNew ? "Nouvel événement" : "Modifier l'événement")</FluentLabel>
    </FluentDialogHeader>

    <FluentDialogBody>
        <EditForm EditContext="_editContext">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">

                <FluentStack>
                    <FluentLabel>Agenda</FluentLabel>
                    <FluentSelect TOption="string"
                                  Value="_formModel.AgendaIdValue"
                                  ValueChanged="@OnFormAgendaChanged">
                        @foreach (var agenda in _agendas)
                        {
                            <FluentOption Value="@agenda.Id.ToString(CultureInfo.InvariantCulture)">@agenda.Libelle</FluentOption>
                        }
                    </FluentSelect>
                </FluentStack>

                <FluentStack Orientation="Orientation.Horizontal">
                    <FluentLabel>Titre</FluentLabel>
                    <FluentTextField @bind-Value="_formModel.Libelle" Required="true" />
                </FluentStack>

                <FluentStack Orientation="Orientation.Horizontal">
                    <FluentLabel>Description</FluentLabel>
                    <FluentTextArea @bind-Value="_formModel.Description" Rows="3" />
                </FluentStack>

                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="12" Wrap="true">
                    <FluentLabel>Début</FluentLabel>
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                        <InputDate @bind-Value="_formModel.StartLocal" class="form-control" />
                        <input type="time"
                               value="@_formModel.StartTime.ToString(@"hh\:mm")"
                               @onchange="@(e => _formModel.StartTime = TimeSpan.Parse(e.Value?.ToString() ?? "00:00"))"
                               disabled="@_formModel.AllDay"
                               class="form-control" />
                    </FluentStack>
                </FluentStack>

                <FluentStack Orientation="Orientation.Horizontal">
                    <FluentLabel>Fin</FluentLabel>
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                        <InputDate @bind-Value="_formModel.EndLocal" class="form-control" />
                        <input type="time"
                               value="@_formModel.EndTime.ToString(@"hh\:mm")"
                               @onchange="@(e => _formModel.EndTime = TimeSpan.Parse(e.Value?.ToString() ?? "00:00"))"
                               disabled="@_formModel.AllDay"
                               class="form-control" />
                    </FluentStack>
                </FluentStack>

                <FluentCheckbox Value="_formModel.AllDay"
                                ValueChanged="@((bool value) => _formModel.AllDay = value)">
                    Toute la journée
                </FluentCheckbox>
                <FluentCheckbox Value="_formModel.IsPrivate"
                                ValueChanged="@((bool value) => _formModel.IsPrivate = value)">
                    Privé
                </FluentCheckbox>

                <FluentStack Orientation="Orientation.Horizontal">
                    <FluentLabel>Statut</FluentLabel>
                    <FluentSelect TOption="string"
                                  Value="_formModel.StatusIdValue"
                                  ValueChanged="@OnFormStatusChanged">
                        @foreach (var status in _statuses)
                        {
                            <FluentOption Value="@status.Id.ToString(CultureInfo.InvariantCulture)">@status.Libelle</FluentOption>
                        }
                    </FluentSelect>
                </FluentStack>

                <FluentCheckbox Value="_formModel.EnableReminders"
                                ValueChanged="@((bool value) => OnEnableRemindersChanged(value))">
                    Activer les rappels
                </FluentCheckbox>

                @if (_formModel.EnableReminders)
                {
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                        @foreach (var reminder in _formModel.Reminders)
                        {
                            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8" Wrap="true" Class="agenda-reminder-row">
                                <FluentStack Orientation="Orientation.Horizontal">
                                    <FluentLabel>Minutes</FluentLabel>
                                    <FluentNumberField Value="reminder.OffsetMinutes"
                                                       ValueChanged="@((int value) => reminder.OffsetMinutes = value)"
                                                       Style="width: 100px;" />
                                </FluentStack>
                                <FluentStack Orientation="Orientation.Horizontal">
                                    <FluentLabel>Canal</FluentLabel>
                                    <FluentSelect TOption="string"
                                                  Value="reminder.ChannelValue"
                                                  ValueChanged="@(value => OnReminderChannelChanged(reminder, value))">
                                        @foreach (var channel in _channels)
                                        {
                                            <FluentOption Value="@channel.Id.ToString(CultureInfo.InvariantCulture)">@channel.Libelle</FluentOption>
                                        }
                                    </FluentSelect>
                                </FluentStack>
                                <FluentButton Appearance="Appearance.Stealth" OnClick="@(() => RemoveReminder(reminder))">Supprimer</FluentButton>
                            </FluentStack>
                        }

                        <FluentButton Appearance="Appearance.Accent" OnClick="@AddReminderAsync">Ajouter un rappel</FluentButton>
                    </FluentStack>
                }
            </FluentStack>
        </EditForm>
    </FluentDialogBody>

    <FluentDialogFooter>
        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8" Wrap="true">
            @if (!_formModel.IsNew)
            {
                <FluentButton Appearance="Appearance.Stealth" OnClick="@DeleteEventAsync" Disabled="@_isSaving">Supprimer</FluentButton>
            }
            <FluentButton Appearance="Appearance.Stealth" OnClick="@CloseDialog" Disabled="@_isSaving">Annuler</FluentButton>
            <FluentButton Appearance="Appearance.Accent" OnClick="@SaveEventFromButtonAsync" Disabled="@_isSaving">Enregistrer</FluentButton>
        </FluentStack>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private readonly AgendaEventFormModel _formModel = new();
    private readonly List<SAgenda> _agendas = new();
    private readonly List<RAgendaEventStatus> _statuses = new();
    private readonly List<RReminderChannel> _channels = new();
    private readonly List<SAgendaEvent> _events = new();

    private EditContext _editContext = default!;
    private DotNetObjectReference<Agenda>? _dotNetRef;
    private IJSObjectReference? _agendaModule;

    private bool _loaded;
    private bool _dialogHidden = true;
    private bool _isSaving;
    private string? _errorMessage;
    private string _selectedView = "timeGridWeek";
    private string? _selectedAgendaKey;
    private DateTime? _visibleRangeStartUtc;
    private DateTime? _visibleRangeEndUtc;

    private IEnumerable<SAgendaEvent> UpcomingEvents => _events
        .Where(e => !_selectedAgendaId.HasValue || e.AgendaId == _selectedAgendaId)
        .Where(e => e.StartUtc >= DateTime.UtcNow)
        .OrderBy(e => e.StartUtc)
        .Take(5);

    private int? _selectedAgendaId => int.TryParse(_selectedAgendaKey, out var value) ? value : _agendas.FirstOrDefault()?.Id;

    protected override async Task OnInitializedAsync()
    {
        // EditContext valide dès le premier rendu
        _editContext = new EditContext(_formModel);
        
        await base.OnInitializedAsync();

        try
        {
            await using var db = await DbContextFactory.CreateDbContextAsync();
            var userId = UserContext.UserId;

            var ownedAgendas = await db.SAgendas
                .Where(a => a.OwnerUserId == userId && !a.Deleted)
                .AsNoTracking()
                .ToListAsync();

            var sharedIds = await db.SAgendaUsers
                .Where(x => x.UserId == userId && !x.Deleted)
                .Select(x => x.AgendaId)
                .ToListAsync();

            if (sharedIds.Count > 0)
            {
                var sharedAgendas = await db.SAgendas
                    .Where(a => sharedIds.Contains(a.Id) && !a.Deleted)
                    .AsNoTracking()
                    .ToListAsync();
                ownedAgendas.AddRange(sharedAgendas);
            }

            _agendas.Clear();
            _agendas.AddRange(ownedAgendas
                .DistinctBy(a => a.Id)
                .OrderBy(a => a.Libelle));

            _statuses.Clear();
            _statuses.AddRange(await db.RAgendaEventStatuses.AsNoTracking().ToListAsync());

            _channels.Clear();
            _channels.AddRange(await db.RReminderChannels.AsNoTracking().ToListAsync());

            _selectedAgendaKey = _agendas.FirstOrDefault()?.Id.ToString(CultureInfo.InvariantCulture);
            _formModel.AgendaId = _selectedAgendaId ?? 0;
            _formModel.StatusId = _statuses.FirstOrDefault()?.Id ?? 0;
            _formModel.StartLocal = DateTime.Now;
            _formModel.EndLocal = DateTime.Now.AddHours(1);

            _editContext = new EditContext(_formModel);

            await LoadEventsAsync();
            _loaded = true;
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            _agendaModule = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "/js/aionAgenda.js");
            await _agendaModule.InvokeVoidAsync("initCalendar", _dotNetRef, _selectedAgendaId, _selectedView);
            await PushEventsToCalendarAsync();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_agendaModule is not null)
        {
            await _agendaModule.DisposeAsync();
        }

        _dotNetRef?.Dispose();
    }

    private async Task LoadEventsAsync(DateTime? rangeStartUtc = null, DateTime? rangeEndUtc = null)
    {
        if (!_agendas.Any())
        {
            _events.Clear();
            return;
        }

        var from = rangeStartUtc ?? _visibleRangeStartUtc ?? DateTime.UtcNow.Date.AddMonths(-1);
        var to = rangeEndUtc ?? _visibleRangeEndUtc ?? DateTime.UtcNow.Date.AddMonths(3);

        _visibleRangeStartUtc = from;
        _visibleRangeEndUtc = to;

        var events = await AgendaService.GetEventsForUserAsync(UserContext.UserId, from, to);
        _events.Clear();
        _events.AddRange(events);

        await PushEventsToCalendarAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task PushEventsToCalendarAsync()
    {
        if (_agendaModule is null)
        {
            return;
        }

        var events = _events
            .Where(e => !_selectedAgendaId.HasValue || e.AgendaId == _selectedAgendaId)
            .Select(e => new
            {
                id = e.Id.ToString(CultureInfo.InvariantCulture),
                title = e.Libelle,
                start = e.StartUtc.ToString("o", CultureInfo.InvariantCulture),
                end = e.EndUtc.ToString("o", CultureInfo.InvariantCulture),
                allDay = e.AllDay,
                extendedProps = new
                {
                    agendaId = e.AgendaId,
                    description = e.Description
                }
            });

        await _agendaModule.InvokeVoidAsync("setEvents", events);
    }

    private Task CloseDialog()
    {
        _dialogHidden = true;
        return Task.CompletedTask;
    }

    private Task OnEnableRemindersChanged(bool value)
    {
        if (value && _formModel.Reminders.Count == 0)
        {
            AddReminderInternal();
        }
        else if (!value)
        {
            _formModel.Reminders.Clear();
        }

        _formModel.EnableReminders = value;
        return Task.CompletedTask;
    }

    private async Task OnAgendaChangedAsync(string? agendaKey)
    {
        _selectedAgendaKey = agendaKey;
        _formModel.AgendaId = _selectedAgendaId ?? _formModel.AgendaId;
        await PushEventsToCalendarAsync();
    }

    private Task OnFormAgendaChanged(string? agendaKey)
    {
        _formModel.AgendaIdValue = agendaKey ?? string.Empty;
        return Task.CompletedTask;
    }

    private Task OnFormStatusChanged(string? statusKey)
    {
        _formModel.StatusIdValue = statusKey ?? string.Empty;
        return Task.CompletedTask;
    }

    private Task OnReminderChannelChanged(ReminderModel reminder, string? channelKey)
    {
        reminder.ChannelValue = channelKey ?? string.Empty;
        return Task.CompletedTask;
    }

    private Appearance GetViewAppearance(string view) => string.Equals(_selectedView, view, StringComparison.OrdinalIgnoreCase)
        ? Appearance.Accent
        : Appearance.Stealth;

    private Task OpenCreateDialogAsync()
    {
        PrepareFormForCreate(null, null, false);
        _dialogHidden = false;
        return Task.CompletedTask;
    }

    private void PrepareFormForCreate(DateTime? start, DateTime? end, bool allDay)
    {
        _formModel.Reset();
        _formModel.AgendaId = _selectedAgendaId ?? _agendas.First().Id;
        _formModel.StatusId = _statuses.FirstOrDefault()?.Id ?? _formModel.StatusId;
        var proposedStart = start ?? DateTime.Now;
        var proposedEnd = end ?? start ?? DateTime.Now.AddHours(1);
        _formModel.StartLocal = proposedStart.Kind == DateTimeKind.Utc ? proposedStart.ToLocalTime() : DateTime.SpecifyKind(proposedStart, DateTimeKind.Local);
        _formModel.EndLocal = proposedEnd.Kind == DateTimeKind.Utc ? proposedEnd.ToLocalTime() : DateTime.SpecifyKind(proposedEnd, DateTimeKind.Local);
        _formModel.AllDay = allDay;
        _editContext = new EditContext(_formModel);
    }

    private async Task SaveEventFromButtonAsync()
    {
        if (_editContext.Validate())
        {
            await SaveEventAsync();
        }
    }

    private async Task SaveEventAsync()
    {
        if (_isSaving)
        {
            return;
        }

        _isSaving = true;
        _errorMessage = null;

        try
        {
            var entity = _formModel.ToEntity(UserContext.TenantId, UserContext.UserId);
            var reminders = _formModel.EnableReminders
                ? _formModel.ToReminderEntities(UserContext.TenantId, entity.Id)
                : null;

            if (_formModel.IsNew)
            {
                var created = await AgendaService.CreateEventAsync(entity, reminders);
                _formModel.EventId = created.Id;
            }
            else
            {
                await AgendaService.UpdateEventAsync(entity, reminders);
            }

            _dialogHidden = true;
            await LoadEventsAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task DeleteEventAsync()
    {
        if (_formModel.IsNew || _formModel.EventId == 0)
        {
            return;
        }

        try
        {
            await AgendaService.DeleteEventAsync(_formModel.EventId);
            _dialogHidden = true;
            await LoadEventsAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
    }

    private Task AddReminderAsync()
    {
        AddReminderInternal();
        return Task.CompletedTask;
    }

    private void AddReminderInternal()
    {
        if (_channels.Count == 0)
        {
            return;
        }

        var defaultChannel = _channels.First();
        _formModel.AddReminder(defaultChannel.Id);
    }

    private void RemoveReminder(ReminderModel reminder)
    {
        _formModel.RemoveReminder(reminder);
    }

    private async Task LoadEventForEditAsync(int eventId)
    {
        try
        {
            await using var db = await DbContextFactory.CreateDbContextAsync();
            var evt = await db.SAgendaEvents
                .Include(e => e.Reminders)
                .AsNoTracking()
                .FirstOrDefaultAsync(e => e.Id == eventId);

            if (evt is null)
            {
                return;
            }

            _formModel.LoadFromEntity(evt, evt.Reminders);
            _editContext = new EditContext(_formModel);
            _dialogHidden = false;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
    }

    private async Task GoTodayAsync()
    {
        if (_agendaModule is not null)
        {
            await _agendaModule.InvokeVoidAsync("goToday");
        }
    }

    private async Task GoPrevAsync()
    {
        if (_agendaModule is not null)
        {
            await _agendaModule.InvokeVoidAsync("goPrev");
        }
    }

    private async Task GoNextAsync()
    {
        if (_agendaModule is not null)
        {
            await _agendaModule.InvokeVoidAsync("goNext");
        }
    }

    private async Task ChangeViewAsync(string view)
    {
        _selectedView = view;
        if (_agendaModule is not null)
        {
            await _agendaModule.InvokeVoidAsync("changeView", view);
        }
    }

    private Task ShowMonthViewAsync() => ChangeViewAsync("dayGridMonth");

    private Task ShowWeekViewAsync() => ChangeViewAsync("timeGridWeek");

    private Task ShowDayViewAsync() => ChangeViewAsync("timeGridDay");

    [JSInvokable]
    public async Task OnEventClickAsync(string eventId)
    {
        if (!int.TryParse(eventId, NumberStyles.Integer, CultureInfo.InvariantCulture, out var id))
        {
            return;
        }

        await LoadEventForEditAsync(id);
    }

    [JSInvokable]
    public async Task OnEventCreatedAsync(string startStr, string endStr, bool allDay)
    {
        var startUtc = DateTime.Parse(startStr, CultureInfo.InvariantCulture, DateTimeStyles.AdjustToUniversal | DateTimeStyles.AssumeUniversal);
        var endUtc = string.IsNullOrWhiteSpace(endStr)
            ? startUtc.AddHours(1)
            : DateTime.Parse(endStr, CultureInfo.InvariantCulture, DateTimeStyles.AdjustToUniversal | DateTimeStyles.AssumeUniversal);

        PrepareFormForCreate(startUtc, endUtc, allDay);
        await InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public async Task OnVisibleRangeChangedAsync(string startStr, string endStr)
    {
        if (string.IsNullOrWhiteSpace(startStr) || string.IsNullOrWhiteSpace(endStr))
        {
            return;
        }

        var startUtc = DateTime.Parse(startStr, CultureInfo.InvariantCulture, DateTimeStyles.AdjustToUniversal | DateTimeStyles.AssumeUniversal);
        var endUtc = DateTime.Parse(endStr, CultureInfo.InvariantCulture, DateTimeStyles.AdjustToUniversal | DateTimeStyles.AssumeUniversal);

        if (_visibleRangeStartUtc.HasValue && _visibleRangeEndUtc.HasValue && _visibleRangeStartUtc.Value == startUtc && _visibleRangeEndUtc.Value == endUtc)
        {
            return;
        }

        await LoadEventsAsync(startUtc, endUtc);
    }

    private sealed class AgendaEventFormModel
    {
        public int EventId { get; set; }
        public int AgendaId { get; set; }

        public string AgendaIdValue
        {
            get => AgendaId.ToString(CultureInfo.InvariantCulture);
            set
            {
                if (string.IsNullOrWhiteSpace(value))
                {
                    AgendaId = 0;
                }
                else if (int.TryParse(value, NumberStyles.Integer, CultureInfo.InvariantCulture, out var parsed))
                {
                    AgendaId = parsed;
                }
            }
        }

        [Required]
        public string Libelle { get; set; } = string.Empty;

        public string? Description { get; set; }
        public DateTime StartLocal { get; set; } = DateTime.Now;
        public DateTime EndLocal { get; set; } = DateTime.Now.AddHours(1);

        public TimeSpan StartTime
        {
            get => StartLocal.TimeOfDay;
            set => StartLocal = DateTime.SpecifyKind(StartLocal.Date.Add(value), DateTimeKind.Local);
        }

        public TimeSpan EndTime
        {
            get => EndLocal.TimeOfDay;
            set => EndLocal = DateTime.SpecifyKind(EndLocal.Date.Add(value), DateTimeKind.Local);
        }

        public bool AllDay { get; set; }
        public bool IsPrivate { get; set; }
        public int StatusId { get; set; }

        public string StatusIdValue
        {
            get => StatusId.ToString(CultureInfo.InvariantCulture);
            set
            {
                if (string.IsNullOrWhiteSpace(value))
                {
                    StatusId = 0;
                }
                else if (int.TryParse(value, NumberStyles.Integer, CultureInfo.InvariantCulture, out var parsed))
                {
                    StatusId = parsed;
                }
            }
        }

        public string? ContextEntityType { get; set; }
        public Guid? ContextEntityId { get; set; }
        public bool EnableReminders { get; set; }
        public bool Actif { get; set; } = true;
        public bool Doc { get; set; }
        public bool Deleted { get; set; }

        public bool IsNew => EventId == 0;
        public List<ReminderModel> Reminders { get; } = new();

        public void Reset()
        {
            EventId = 0;
            Libelle = string.Empty;
            Description = null;
            AllDay = false;
            IsPrivate = false;
            EnableReminders = false;
            Reminders.Clear();
            var now = DateTime.Now;
            StartLocal = now;
            EndLocal = now.AddHours(1);
        }

        public void LoadFromEntity(SAgendaEvent evt, IEnumerable<SAgendaReminder>? reminders)
        {
            EventId = evt.Id;
            AgendaId = evt.AgendaId;
            Libelle = evt.Libelle;
            Description = evt.Description;
            StartLocal = evt.StartUtc.ToLocalTime();
            EndLocal = evt.EndUtc.ToLocalTime();
            AllDay = evt.AllDay;
            IsPrivate = evt.IsPrivate;
            StatusId = evt.StatusId;
            ContextEntityType = evt.ContextEntityType;
            ContextEntityId = evt.ContextEntityId;
            EnableReminders = evt.EnableReminders;
            Actif = evt.Actif;
            Doc = evt.Doc;
            Deleted = evt.Deleted;

            Reminders.Clear();

            foreach (var reminder in reminders ?? Enumerable.Empty<SAgendaReminder>())
            {
                Reminders.Add(new ReminderModel
                {
                    ReminderId = reminder.Id,
                    OffsetMinutes = reminder.OffsetMinutes,
                    ChannelId = reminder.ChannelId
                });
            }

            if (EnableReminders && Reminders.Count == 0)
            {
                EnableReminders = false;
            }
        }

        public SAgendaEvent ToEntity(int tenantId, int userId)
        {
            var start = DateTime.SpecifyKind(StartLocal, DateTimeKind.Local);
            var end = DateTime.SpecifyKind(EndLocal, DateTimeKind.Local);

            if (AllDay)
            {
                start = start.Date;
                end = end.Date.AddDays(1);
            }

            return new SAgendaEvent
            {
                Id = EventId,
                AgendaId = AgendaId,
                Libelle = Libelle,
                Description = Description,
                StartUtc = start.ToUniversalTime(),
                EndUtc = end.ToUniversalTime(),
                AllDay = AllDay,
                IsPrivate = IsPrivate,
                StatusId = StatusId,
                ContextEntityType = ContextEntityType,
                ContextEntityId = ContextEntityId,
                EnableReminders = EnableReminders,
                TenantId = tenantId,
                Actif = Actif,
                Doc = Doc,
                Deleted = Deleted,
                UsrModificationId = userId,
                UsrCreationId = IsNew ? userId : (int?)null
            };
        }

        public IEnumerable<SAgendaReminder> ToReminderEntities(int tenantId, int eventId)
        {
            var baseStart = AllDay
                ? DateTime.SpecifyKind(StartLocal.Date, DateTimeKind.Local)
                : DateTime.SpecifyKind(StartLocal, DateTimeKind.Local);
            var targetEventId = eventId != 0 ? eventId : EventId;

            return Reminders.Select(reminder => new SAgendaReminder
            {
                Id = reminder.ReminderId,
                AgendaEventId = targetEventId,
                OffsetMinutes = reminder.OffsetMinutes,
                ChannelId = reminder.ChannelId,
                TriggerAtUtc = baseStart.AddMinutes(reminder.OffsetMinutes).ToUniversalTime(),
                TenantId = tenantId,
                Actif = true,
                Deleted = false
            }).ToList();
        }

        public void AddReminder(int defaultChannelId)
        {
            Reminders.Add(new ReminderModel
            {
                ChannelId = defaultChannelId,
                OffsetMinutes = -15
            });
            EnableReminders = true;
        }

        public void RemoveReminder(ReminderModel reminder)
        {
            Reminders.Remove(reminder);
            if (Reminders.Count == 0)
            {
                EnableReminders = false;
            }
        }
    }

    private sealed class ReminderModel
    {
        public int ReminderId { get; set; }
        public int OffsetMinutes { get; set; } = -15;
        public int ChannelId { get; set; }

        public string ChannelValue
        {
            get => ChannelId.ToString(CultureInfo.InvariantCulture);
            set
            {
                if (string.IsNullOrWhiteSpace(value))
                {
                    ChannelId = 0;
                }
                else if (int.TryParse(value, NumberStyles.Integer, CultureInfo.InvariantCulture, out var parsed))
                {
                    ChannelId = parsed;
                }
            }
        }
    }
}
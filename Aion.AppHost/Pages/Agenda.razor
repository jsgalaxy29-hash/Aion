@page "/agenda"
@using Aion.DataEngine.Interfaces
@using Aion.Infrastructure
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using System.Linq
@using Aion.Domain.Agenda
@inject IAgendaService AgendaService
@inject IUserContext UserContext
@inject IDbContextFactory<AionDbContext> DbContextFactory
@attribute [Authorize]

<FluentLabel Typo="Typography.H2">Agenda</FluentLabel>

@if (!_loaded)
{
    <FluentLabel>Chargement des agendas...</FluentLabel>
}
else if (!_agendas.Any())
{
    <FluentLabel>Aucun agenda disponible pour votre compte.</FluentLabel>
}
else
{
    <EditForm Model="_formModel" OnValidSubmit="CreateEventAsync">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="agenda-form">
            <FluentLabel>Agenda</FluentLabel>
            <select @bind="_formModel.AgendaId">
                @foreach (var agenda in _agendas)
                {
                    <option value="@agenda.Id">@agenda.Libelle</option>
                }
            </select>

            <FluentLabel>Titre</FluentLabel>
            <InputText @bind-Value="_formModel.Libelle" class="form-input" />

            <FluentLabel>Description</FluentLabel>
            <InputTextArea @bind-Value="_formModel.Description" class="form-input" />

            <div class="form-grid">
                <div>
                    <FluentLabel>D√©but (UTC)</FluentLabel>
                    <InputDate @bind-Value="_formModel.StartUtc" class="form-input" />
                </div>
                <div>
                    <FluentLabel>Fin (UTC)</FluentLabel>
                    <InputDate @bind-Value="_formModel.EndUtc" class="form-input" />
                </div>
            </div>

            <FluentLabel>Status</FluentLabel>
            <select @bind="_formModel.StatusId">
                @foreach (var status in _statuses)
                {
                    <option value="@status.Id">@status.Libelle</option>
                }
            </select>

            <div class="form-check">
                <input type="checkbox" @bind="_formModel.AllDay" />
                <FluentLabel>Journ√©e enti√®re</FluentLabel>
            </div>

            <div class="form-check">
                <input type="checkbox" @bind="_formModel.IsPrivate" />
                <FluentLabel>Priv√©</FluentLabel>
            </div>

            <div class="form-check">
                <input type="checkbox" @bind="_enableReminders" />
                <FluentLabel>Activer les rappels</FluentLabel>
            </div>

            @if (_enableReminders)
            {
                <div class="reminder-list">
                    @foreach (var reminder in _reminders)
                    {
                        <div class="reminder-row">
                            <input type="number" @bind="reminder.OffsetMinutes" @bind:after="() => NormalizeReminder(reminder)" />
                            <select @bind="reminder.ChannelId">
                                @foreach (var channel in _channels)
                                {
                                    <option value="@channel.Id">@channel.Libelle</option>
                                }
                            </select>
                            <button type="button" @onclick="(() => RemoveReminder(reminder))">üóëÔ∏è</button>
                        </div>
                    }
                    <button type="button" class="btn" @onclick="AddReminder">Ajouter un rappel</button>
                </div>
            }

            <button type="submit" class="btn-primary">Enregistrer l'√©v√©nement</button>
        </div>
    </EditForm>

    <h3>√âv√©nements √† venir</h3>
    @if (!_events.Any())
    {
        <FluentLabel>Aucun √©v√©nement planifi√©.</FluentLabel>
    }
    else
    {
        <table class="agenda-table">
            <thead>
                <tr>
                    <th>Agenda</th>
                    <th>Titre</th>
                    <th>D√©but</th>
                    <th>Fin</th>
                    <th>Statut</th>
                    <th>Priv√©</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var evt in _events.OrderBy(e => e.StartUtc))
                {
                    var agenda = _agendas.FirstOrDefault(a => a.Id == evt.AgendaId);
                    var status = _statuses.FirstOrDefault(s => s.Id == evt.StatusId);
                    <tr>
                        <td>@agenda?.Libelle</td>
                        <td>@evt.Libelle</td>
                        <td>@evt.StartUtc.ToLocalTime()</td>
                        <td>@evt.EndUtc.ToLocalTime()</td>
                        <td>@status?.Libelle</td>
                        <td>@(evt.IsPrivate ? "Oui" : "Non")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@code {
    private readonly AgendaFormModel _formModel = new();
    private bool _enableReminders;
    private bool _loaded;
    private List<SAgenda> _agendas = new();
    private List<RAgendaEventStatus> _statuses = new();
    private List<RReminderChannel> _channels = new();
    private List<SAgendaEvent> _events = new();
    private readonly List<SAgendaReminder> _reminders = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        await using var db = await DbContextFactory.CreateDbContextAsync();

        var userId = UserContext.UserId;

        var ownedAgendas = await db.SAgendas
            .Where(a => a.OwnerUserId == userId && !a.Deleted)
            .AsNoTracking()
            .ToListAsync();

        var sharedIds = await db.SAgendaUsers
            .Where(x => x.UserId == userId && !x.Deleted)
            .Select(x => x.AgendaId)
            .ToListAsync();

        if (sharedIds.Count > 0)
        {
            var sharedAgendas = await db.SAgendas
                .Where(a => sharedIds.Contains(a.Id) && !a.Deleted)
                .AsNoTracking()
                .ToListAsync();
            ownedAgendas.AddRange(sharedAgendas);
        }

        _agendas = ownedAgendas
            .DistinctBy(a => a.Id)
            .OrderBy(a => a.Libelle)
            .ToList();

        _statuses = await db.RAgendaEventStatuses.AsNoTracking().ToListAsync();
        _channels = await db.RReminderChannels.AsNoTracking().ToListAsync();

        if (_agendas.Any())
        {
            _formModel.AgendaId = _agendas.First().Id;
        }
        if (_statuses.Any())
        {
            _formModel.StatusId = _statuses.First().Id;
        }

        _formModel.StartUtc = DateTime.UtcNow;
        _formModel.EndUtc = DateTime.UtcNow.AddHours(1);

        await LoadEventsAsync();
        _loaded = true;
    }

    private async Task LoadEventsAsync()
    {
        if (!_agendas.Any())
        {
            _events = new List<SAgendaEvent>();
            return;
        }

        var from = DateTime.UtcNow.Date.AddDays(-7);
        var to = DateTime.UtcNow.Date.AddDays(30);
        _events = await AgendaService.GetEventsForUserAsync(UserContext.UserId, from, to);
    }

    private void AddReminder()
    {
        var defaultChannel = _channels.FirstOrDefault();
        _reminders.Add(new SAgendaReminder
        {
            OffsetMinutes = -15,
            ChannelId = defaultChannel?.Id ?? 1,
            TriggerAtUtc = _formModel.StartUtc.AddMinutes(-15),
            TenantId = UserContext.TenantId,
            Actif = true
        });
    }

    private void RemoveReminder(SAgendaReminder reminder)
    {
        _reminders.Remove(reminder);
    }

    private void NormalizeReminder(SAgendaReminder reminder)
    {
        reminder.OffsetMinutes = reminder.OffsetMinutes <= 0 ? reminder.OffsetMinutes : -reminder.OffsetMinutes;
        reminder.TriggerAtUtc = _formModel.StartUtc.AddMinutes(reminder.OffsetMinutes);
    }

    private async Task CreateEventAsync(EditContext _)
    {
        _formModel.TenantId = UserContext.TenantId;
        _formModel.Actif = true;
        _formModel.EnableReminders = _enableReminders && _reminders.Count > 0;

        foreach (var reminder in _reminders)
        {
            reminder.TriggerAtUtc = _formModel.StartUtc.AddMinutes(reminder.OffsetMinutes);
            reminder.TenantId = UserContext.TenantId;
            reminder.Actif = true;
        }

        var evt = _formModel.ToEntity();
        await AgendaService.CreateEventAsync(evt, _enableReminders ? _reminders.ToList() : null);

        _formModel.Libelle = string.Empty;
        _formModel.Description = string.Empty;
        _enableReminders = false;
        _reminders.Clear();

        await LoadEventsAsync();
        StateHasChanged();
    }

    private sealed class AgendaFormModel : SAgendaEvent
    {
        public AgendaFormModel()
        {
            EnableReminders = false;
        }

        public SAgendaEvent ToEntity()
        {
            return new SAgendaEvent
            {
                AgendaId = AgendaId,
                Libelle = Libelle,
                Description = Description,
                StartUtc = StartUtc,
                EndUtc = EndUtc,
                AllDay = AllDay,
                IsPrivate = IsPrivate,
                StatusId = StatusId,
                ContextEntityType = ContextEntityType,
                ContextEntityId = ContextEntityId,
                EnableReminders = EnableReminders,
                TenantId = TenantId,
                Actif = Actif,
                Doc = Doc,
                Deleted = Deleted
            };
        }
    }
}

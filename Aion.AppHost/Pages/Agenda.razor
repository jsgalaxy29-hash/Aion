@page "/agenda"
@using Aion.DataEngine.Interfaces
@using Aion.Infrastructure
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using System.Globalization
@using System.Linq
@using Aion.Domain.Agenda
@inject IAgendaService AgendaService
@inject IUserContext UserContext
@inject IDbContextFactory<AionDbContext> DbContextFactory
@inject IJSRuntime JS
@attribute [Authorize]

<FluentLabel Typo="Typography.H2">Agenda</FluentLabel>

@if (!_loaded)
{
    <FluentStack Orientation="Orientation.Horizontal" Gap="8">
        <FluentProgressRing />
        <FluentLabel>Chargement des agendas...</FluentLabel>
    </FluentStack>
}
else if (!_agendas.Any())
{
    <FluentMessageBar Intent="MessageIntent.Warning">
        Aucun agenda disponible pour cet utilisateur.
    </FluentMessageBar>
}
else
{
    <div class="agenda-layout">
        <!-- Colonne gauche : formulaire + prochains événements -->
        <div class="agenda-sidebar">
            <FluentCard Class="agenda-card">
                <FluentLabel Typo="Typography.H5">Nouvel événement</FluentLabel>

                <EditForm Model="_formModel" OnValidSubmit="CreateEventAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="fluent-field">
                        <FluentLabel>Agenda</FluentLabel>
                        <select class="form-select" @bind="_formModel.AgendaId">
                            @foreach (var agenda in _agendas)
                            {
                                <option value="@agenda.Id">@agenda.Libelle</option>
                            }
                        </select>
                    </div>

                    <div class="fluent-field">
                        <FluentLabel>Titre</FluentLabel>
                        <InputText @bind-Value="_formModel.Libelle" class="form-input" />
                    </div>

                    <div class="fluent-field">
                        <FluentLabel>Description</FluentLabel>
                        <InputTextArea @bind-Value="_formModel.Description" class="form-input" />
                    </div>

                    <div class="agenda-dategrid">
                        <div class="fluent-field">
                            <FluentLabel>Début (UTC)</FluentLabel>
                            <InputDate @bind-Value="_formModel.StartUtc" class="form-input" />
                        </div>
                        <div class="fluent-field">
                            <FluentLabel>Fin (UTC)</FluentLabel>
                            <InputDate @bind-Value="_formModel.EndUtc" class="form-input" />
                        </div>
                    </div>

                    <div class="fluent-field">
                        <FluentLabel>Statut</FluentLabel>
                        <select class="form-select" @bind="_formModel.StatusId">
                            @foreach (var status in _statuses)
                            {
                                <option value="@status.Id">@status.Libelle</option>
                            }
                        </select>
                    </div>

                    <div class="agenda-checkboxes">
                        <label class="form-check">
                            <input type="checkbox" @bind="_formModel.AllDay" />
                            <span>Journée entière</span>
                        </label>
                        <label class="form-check">
                            <input type="checkbox" @bind="_formModel.IsPrivate" />
                            <span>Privé</span>
                        </label>
                        <label class="form-check">
                            <input type="checkbox" @bind="_enableReminders" />
                            <span>Activer les rappels</span>
                        </label>
                    </div>

                    @if (_enableReminders)
                    {
                        <div class="fluent-field">
                            <FluentLabel>Rappels</FluentLabel>

                            @foreach (var reminder in _reminders)
                            {
                                <div class="agenda-reminder-row">
                                    <InputNumber @bind-Value="reminder.OffsetMinutes" class="form-input-small" />
                                    <span>minutes avant</span>

                                    <select class="form-select-small" @bind="reminder.ChannelId">
                                        @foreach (var ch in _channels)
                                        {
                                            <option value="@ch.Id">@ch.Libelle</option>
                                        }
                                    </select>

                                    <FluentButton Appearance="Appearance.Stealth"
                                                  OnClick="@(() => RemoveReminder(reminder))">
                                        Supprimer
                                    </FluentButton>
                                </div>
                            }

                            <FluentButton Appearance="Appearance.Stealth" OnClick="AddReminder">
                                Ajouter un rappel
                            </FluentButton>
                        </div>
                    }

                    <FluentButton Appearance="Appearance.Accent" Type="ButtonType.Submit" Class="agenda-submit">
                        Enregistrer
                    </FluentButton>
                </EditForm>
            </FluentCard>

            <FluentCard Class="agenda-card">
                <FluentLabel Typo="Typography.H6">Événements à venir</FluentLabel>

                @if (!_events.Any())
                {
                    <FluentLabel>Aucun événement planifié.</FluentLabel>
                }
                else
                {
                    <ul class="agenda-upcoming">
                        @foreach (var evt in _events.OrderBy(e => e.StartUtc).Take(10))
                        {
                            var agenda = _agendas.FirstOrDefault(a => a.Id == evt.AgendaId);
                            var status = _statuses.FirstOrDefault(s => s.Id == evt.StatusId);

                            <li class="agenda-upcoming-item">
                                <div class="agenda-upcoming-title">@evt.Libelle</div>
                                <div class="agenda-upcoming-meta">
                                    <span>@agenda?.Libelle</span>
                                    <span>@evt.StartUtc.ToLocalTime():g</span>
                                    @if (evt.EndUtc != default)
                                    {
                                        <span>→ @evt.EndUtc.ToLocalTime():t</span>
                                    }
                                    <span>@status?.Libelle</span>
                                </div>
                            </li>
                        }
                    </ul>
                }
            </FluentCard>
        </div>

        <!-- Colonne droite : barre d’outils + FullCalendar -->
        <div class="agenda-main">
            <div class="agenda-toolbar">
                <FluentStack Orientation="Orientation.Horizontal" Gap="8" AlignItems="AlignItems.Center">
                    <FluentButton OnClick="GoToday">Aujourd'hui</FluentButton>
                    <FluentButton OnClick="GoPrev">◀</FluentButton>
                    <FluentButton OnClick="GoNext">▶</FluentButton>

                    <FluentDivider />

                    <FluentButton OnClick="@(() => ChangeView("dayGridMonth"))">Mois</FluentButton>
                    <FluentButton OnClick="@(() => ChangeView("timeGridWeek"))">Semaine</FluentButton>
                    <FluentButton OnClick="@(() => ChangeView("timeGridDay"))">Jour</FluentButton>
                </FluentStack>
            </div>

            <FluentCard Class="agenda-calendar-card">
                <div id="aion-agenda-calendar" style="height:100%;"></div>
            </FluentCard>
        </div>
    </div>
}

@implements IAsyncDisposable

@code {
    private readonly AgendaFormModel _formModel = new();
    private bool _enableReminders;
    private bool _loaded;

    private List<SAgenda> _agendas = new();
    private List<RAgendaEventStatus> _statuses = new();
    private List<RReminderChannel> _channels = new();
    private List<SAgendaEvent> _events = new();
    private readonly List<SAgendaReminder> _reminders = new();
    private DateTime _visibleRangeStartUtc = DateTime.UtcNow.Date.AddDays(-7);
    private DateTime _visibleRangeEndUtc = DateTime.UtcNow.Date.AddDays(30);
    private bool _calendarInitialized;

    // JS interop
    private IJSObjectReference? _agendaJsModule;
    private DotNetObjectReference<Agenda>? _dotNetRef;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        await using var db = await DbContextFactory.CreateDbContextAsync();

        var userId = UserContext.UserId;

        // Agendas possédés
        var ownedAgendas = await db.SAgendas
            .Where(a => a.OwnerUserId == userId && !a.Deleted)
            .AsNoTracking()
            .ToListAsync();

        // Agendas partagés
        var sharedIds = await db.SAgendaUsers
            .Where(x => x.UserId == userId && !x.Deleted)
            .Select(x => x.AgendaId)
            .ToListAsync();

        if (sharedIds.Count > 0)
        {
            var sharedAgendas = await db.SAgendas
                .Where(a => sharedIds.Contains(a.Id) && !a.Deleted)
                .AsNoTracking()
                .ToListAsync();

            ownedAgendas.AddRange(sharedAgendas);
        }

        _agendas = ownedAgendas
            .DistinctBy(a => a.Id)
            .OrderBy(a => a.Libelle)
            .ToList();

        _statuses = await db.RAgendaEventStatuses
            .AsNoTracking()
            .ToListAsync();

        _channels = await db.RReminderChannels
            .AsNoTracking()
            .ToListAsync();

        if (_agendas.Any())
        {
            _formModel.AgendaId = _agendas.First().Id;
        }

        if (_statuses.Any())
        {
            _formModel.StatusId = _statuses.First().Id;
        }

        _formModel.StartUtc = DateTime.UtcNow;
        _formModel.EndUtc = DateTime.UtcNow.AddHours(1);

        await LoadEventsAsync();

        _loaded = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_loaded && !_calendarInitialized)
        {
            _agendaJsModule ??= await JS.InvokeAsync<IJSObjectReference>("import", "/js/aionAgenda.js");
            _dotNetRef ??= DotNetObjectReference.Create(this);

            // initCalendar(dotNetRef, selectedAgendaId, defaultView)
            await _agendaJsModule.InvokeVoidAsync(
                "initCalendar",
                _dotNetRef,
                null,
                "timeGridWeek");

            _calendarInitialized = true;

            if (_events.Any())
            {
                var jsEvents = _events.Select(e => new
                {
                    id = e.Id.ToString(),
                    title = e.Libelle,
                    start = e.StartUtc,
                    end = e.EndUtc,
                    allDay = e.AllDay
                });

                await _agendaJsModule.InvokeVoidAsync("setEvents", jsEvents);
            }

            // Le premier datesSet côté JS rappellera OnVisibleRangeChangedAsync, qui chargera les events.
        }
    }

    private async Task LoadEventsAsync()
    {
        if (!_agendas.Any())
        {
            _events = new List<SAgendaEvent>();
            return;
        }

        _events = await AgendaService.GetEventsForUserAsync(UserContext.UserId, _visibleRangeStartUtc, _visibleRangeEndUtc);
    }

    [JSInvokable]
    public async Task OnVisibleRangeChangedAsync(string startStr, string endStr)
    {
        if (DateTime.TryParse(startStr, CultureInfo.InvariantCulture, DateTimeStyles.AssumeUniversal | DateTimeStyles.AdjustToUniversal, out var rangeStartUtc))
        {
            _visibleRangeStartUtc = rangeStartUtc;
        }

        if (DateTime.TryParse(endStr, CultureInfo.InvariantCulture, DateTimeStyles.AssumeUniversal | DateTimeStyles.AdjustToUniversal, out var rangeEndUtc))
        {
            _visibleRangeEndUtc = rangeEndUtc;
        }

        await LoadEventsAsync();

        if (_agendaJsModule is null)
            return;

        // Projection des événements au format attendu par FullCalendar
        var jsEvents = _events.Select(e => new
        {
            id = e.Id.ToString(),
            title = e.Libelle,
            start = e.StartUtc,
            end = e.EndUtc,
            allDay = e.AllDay
        });

        await _agendaJsModule.InvokeVoidAsync("setEvents", jsEvents);
        StateHasChanged();
    }

    [JSInvokable]
    public Task OnEventCreatedAsync(string startStr, string endStr, bool allDay)
    {
        if (DateTime.TryParse(startStr, out var start))
        {
            _formModel.StartUtc = DateTime.SpecifyKind(start, DateTimeKind.Utc);
        }

        if (DateTime.TryParse(endStr, out var end))
        {
            _formModel.EndUtc = DateTime.SpecifyKind(end, DateTimeKind.Utc);
        }

        _formModel.AllDay = allDay;

        StateHasChanged();
        return Task.CompletedTask;
    }

    // Pour l’instant, on ne fait rien de spécial sur le clic d’événement
    [JSInvokable]
    public Task OnEventClickAsync(string eventId)
    {
        // Si plus tard tu veux remplir _formModel pour éditer : il faudra adapter ici
        return Task.CompletedTask;
    }

    private void AddReminder()
    {
        var defaultChannel = _channels.FirstOrDefault();

        _reminders.Add(new SAgendaReminder
        {
            OffsetMinutes = -15,
            ChannelId = defaultChannel?.Id ?? 1,
            TriggerAtUtc = _formModel.StartUtc.AddMinutes(-15),
            TenantId = UserContext.TenantId,
            Actif = true
        });
    }

    private void RemoveReminder(SAgendaReminder reminder)
    {
        _reminders.Remove(reminder);
    }

    private void NormalizeReminder(SAgendaReminder reminder)
    {
        reminder.OffsetMinutes = reminder.OffsetMinutes <= 0
            ? reminder.OffsetMinutes
            : -reminder.OffsetMinutes;

        reminder.TriggerAtUtc = _formModel.StartUtc.AddMinutes(reminder.OffsetMinutes);
    }

    private async Task CreateEventAsync(EditContext _)
    {
        _formModel.TenantId = UserContext.TenantId;
        _formModel.Actif = true;
        _formModel.EnableReminders = _enableReminders && _reminders.Count > 0;

        foreach (var reminder in _reminders)
        {
            NormalizeReminder(reminder);
            reminder.TenantId = UserContext.TenantId;
            reminder.Actif = true;
        }

        var evt = _formModel.ToEntity();

        await AgendaService.CreateEventAsync(
            evt,
            _enableReminders ? _reminders.ToList() : null);

        _formModel.Libelle = string.Empty;
        _formModel.Description = string.Empty;
        _enableReminders = false;
        _reminders.Clear();

        await LoadEventsAsync();

        // On rafraîchit aussi FullCalendar
        if (_agendaJsModule is not null)
        {
            var jsEvents = _events.Select(e => new
            {
                id = e.Id.ToString(),
                title = e.Libelle,
                start = e.StartUtc,
                end = e.EndUtc,
                allDay = e.AllDay
            });

            await _agendaJsModule.InvokeVoidAsync("setEvents", jsEvents);
        }

        StateHasChanged();
    }

    private async Task GoToday()
    {
        if (_agendaJsModule is not null)
        {
            await _agendaJsModule.InvokeVoidAsync("goToday");
        }
    }

    private async Task GoPrev()
    {
        if (_agendaJsModule is not null)
        {
            await _agendaJsModule.InvokeVoidAsync("goPrev");
        }
    }

    private async Task GoNext()
    {
        if (_agendaJsModule is not null)
        {
            await _agendaJsModule.InvokeVoidAsync("goNext");
        }
    }

    private async Task ChangeView(string viewName)
    {
        if (_agendaJsModule is not null)
        {
            await _agendaJsModule.InvokeVoidAsync("changeView", viewName);
        }
    }

    private sealed class AgendaFormModel : SAgendaEvent
    {
        public AgendaFormModel()
        {
            EnableReminders = false;
        }

        public SAgendaEvent ToEntity()
        {
            return new SAgendaEvent
            {
                AgendaId = AgendaId,
                Libelle = Libelle,
                Description = Description,
                StartUtc = StartUtc,
                EndUtc = EndUtc,
                AllDay = AllDay,
                IsPrivate = IsPrivate,
                StatusId = StatusId,
                ContextEntityType = ContextEntityType,
                ContextEntityId = ContextEntityId,
                EnableReminders = EnableReminders,
                TenantId = TenantId,
                Actif = Actif,
                Doc = Doc,
                Deleted = Deleted
            };
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_agendaJsModule is not null)
        {
            try
            {
                await _agendaJsModule.InvokeVoidAsync("disposeCalendar");
            }
            catch (JSDisconnectedException)
            {
                // Ignored: the circuit is gone.
            }
            catch (ObjectDisposedException)
            {
                // Module already disposed.
            }

            await _agendaJsModule.DisposeAsync();
            _agendaJsModule = null;
        }

        _dotNetRef?.Dispose();
        _dotNetRef = null;
        _calendarInitialized = false;
    }
}

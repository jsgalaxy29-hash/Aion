@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.FluentUI.AspNetCore.Components.Icons
@using Aion.DataEngine.Models

<div class="aion-grid">
    @if (_isLoading)
    {
        <div class="d-flex align-items-center gap-2"><FluentProgressRing /> Chargement de la table...</div>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <FluentMessageBar Intent="MessageIntent.Error">@_errorMessage</FluentMessageBar>
    }
    else if (_tableMetadata is null)
    {
        <FluentMessageBar Intent="MessageIntent.Info">Table inconnue.</FluentMessageBar>
    }
    else
    {
        <div class="grid-toolbar">
            <div class="d-flex flex-wrap gap-2 align-items-center">
                <FluentLabel Typo="Typography.H5">@_tableMetadata.Libelle</FluentLabel>
                <FluentButton Appearance="Appearance.Accent" OnClick="CreateRow">Nouvelle ligne</FluentButton>
                <FluentButton Appearance="Appearance.Stealth" OnClick="ReloadAsync" Icon="ArrowClockwise16Filled">Rafra√Æchir</FluentButton>
                <FluentButton Appearance="Appearance.Outline" OnClick="OpenLayoutEditor" Icon="Settings20Regular">Personnaliser</FluentButton>
            </div>
            <FluentLabel Typo="Typography.Body">@(_filteredCount) ligne(s) - page @_page / @_pageCount</FluentLabel>
        </div>

        @if (_searchableColumns.Count > 0)
        {
            <div class="search-panel mb-3">
                <FluentLabel Typo="Typography.H6">Filtres</FluentLabel>
                <div class="search-grid">
                    @foreach (var column in _searchableColumns)
                    {
                        <div class="search-item">
                            <FluentLabel>@column.DisplayName</FluentLabel>
                            @switch (column.InputKind)
                            {
                                case DynamicColumnInputKind.Boolean:
                                    <FluentSelect TOption="string"
                                                  Value="@GetSearchValue(column.FieldName)"
                                                  ValueChanged="@(async (string? value) => await OnSearchChanged(column.FieldName, value))"
                                                  Style="min-width:120px;">
                                        <FluentOption Value="">(Tous)</FluentOption>
                                        <FluentOption Value="true">Oui</FluentOption>
                                        <FluentOption Value="false">Non</FluentOption>
                                    </FluentSelect>
                                    break;
                                case DynamicColumnInputKind.Date:
                                    <input type="date"
                                           class="form-control"
                                           value="@GetSearchValue(column.FieldName)"
                                           @onchange="@(async e => await OnSearchChanged(column.FieldName, e.Value?.ToString()))" />
                                    break;
                                case DynamicColumnInputKind.DateTime:
                                    <input type="datetime-local"
                                           class="form-control"
                                           value="@GetSearchValue(column.FieldName)"
                                           @onchange="@(async e => await OnSearchChanged(column.FieldName, e.Value?.ToString()))" />
                                    break;
                                case DynamicColumnInputKind.Number or DynamicColumnInputKind.Decimal:
                                    <input type="number"
                                           class="form-control"
                                           value="@GetSearchValue(column.FieldName)"
                                           @onchange="@(async e => await OnSearchChanged(column.FieldName, e.Value?.ToString()))" />
                                    break;
                                case DynamicColumnInputKind.Select when column.Options is not null:
                                    <FluentSelect TOption="string"
                                                  Value="@GetSearchValue(column.FieldName)"
                                                  ValueChanged="@(async (string? value) => await OnSearchChanged(column.FieldName, value))"
                                                  Style="min-width:180px;">
                                        <FluentOption Value="">(Tous)</FluentOption>
                                        @foreach (var option in column.Options)
                                        {
                                            <FluentOption Value="@option.Value">@option.Label</FluentOption>
                                        }
                                    </FluentSelect>
                                    break;
                                default:
                                    <FluentTextField Value="@GetSearchValue(column.FieldName)"
                                                     ValueChanged="@(async (string? value) => await OnSearchChanged(column.FieldName, value))" />
                                    break;
                            }
                        </div>
                    }
                </div>
            </div>
        }

        @if (_rows.Count == 0)
        {
            <FluentCard class="text-center py-4">
                <FluentLabel Typo="Typography.Body">Aucune donn√©e.</FluentLabel>
            </FluentCard>
        }
        else
        {
            <FluentDataGrid Items="@_rows.AsQueryable()"
                            TGridItem="DynamicRow"
                            GridTemplateColumns="@GridTemplateColumns"
                            SelectionMode="DataGridSelectionMode.None">
                @foreach (var column in VisibleColumns)
                {
                    var col = column;
                    var sortIndex = _sortDescriptors.FindIndex(s => string.Equals(s.FieldName, col.FieldName, StringComparison.OrdinalIgnoreCase));
                    var descriptor = sortIndex >= 0 ? _sortDescriptors[sortIndex] : null;
                    var isSorted = descriptor is not null;

                    <TemplateColumn TGridItem="DynamicRow">
                        <HeaderCellTitleTemplate>
                            <FluentButton Appearance="Appearance.Stealth"
                                          Size="ButtonSize.Small"
                                          OnClick="@(async (MouseEventArgs e) => await OnColumnHeaderClick(col, e))">
                                @col.DisplayName

                                @if (isSorted)
                                {
                                    <span style="margin-left:4px;">
                                        @((descriptor!.Descending ? "‚ñº" : "‚ñ≤"))
                                        @if (_sortDescriptors.Count > 1)
                                        {
                                            <sup>@(sortIndex + 1)</sup> @* ordre de tri : 1,2,3... *@
                                        }
                                    </span>
                                }
                            </FluentButton>
                        </HeaderCellTitleTemplate>

                        <ChildContent Context="row">
                            <div class="grid-cell-content" @ondblclick="@(() => HandleRowDoubleClick(row))">
                                @if (row.IsEditing)
                                {
                                    @RenderEditCell(row, col)
                                }
                                else
                                {
                                    @RenderReadCell(row, col)
                                }
                            </div>
                        </ChildContent>
                    </TemplateColumn>
                }
                <TemplateColumn TGridItem="DynamicRow" >
                    <HeaderCellTitleTemplate>
                        <FluentLabel>Actions</FluentLabel>
                    </HeaderCellTitleTemplate>

                    <ChildContent Context="row">
                        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="4">
                            @if (row.IsEditing)
                            {
                                <FluentButton Appearance="Appearance.Accent"
                                              OnClick="@(() => SaveRowAsync(row))">
                                    üíæ Sauver
                                </FluentButton>
                                <FluentButton Appearance="Appearance.Stealth"
                                              OnClick="@(() => CancelEdit(row))">
                                    ‚úñ Annuler
                                </FluentButton>
                            }
                            else
                            {
                                <FluentButton Appearance="Appearance.Stealth"
                                              OnClick="@(() => StartEdit(row))">
                                    ‚úè Modifier
                                </FluentButton>
                                <FluentButton Appearance="Appearance.Outline"
                                              OnClick="@(() => DeleteRowAsync(row))">
                                    üóë Supprimer
                                </FluentButton>
                            }
                        </FluentStack>
                    </ChildContent>
                </TemplateColumn>
            </FluentDataGrid>
        }

        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" class="mt-2">
            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8">
                <FluentLabel>Page</FluentLabel>
                <FluentButton Appearance="Appearance.Stealth"
                              Disabled="@(_page <= 1)"
                              OnClick="@(async () => await PrevPage())">
                    ‚óÄ
                </FluentButton>
                <FluentLabel>@_page / @_pageCount</FluentLabel>
                <FluentButton Appearance="Appearance.Stealth"
                              Disabled="@(_page >= _pageCount)"
                              OnClick="@(async () => await NextPage())">
                    ‚ñ∂
                </FluentButton>
            </FluentStack>
            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8">
                <FluentLabel>Elements / page</FluentLabel>
                <FluentSelect TOption="int"
                              Items="@_pageSizes"
                              SelectedOption="@_pageSize"
                              SelectedOptionChanged="@(async (int size) => await OnPageSizeChangedFluent(size))">
                    <OptionTemplate>@context</OptionTemplate>
                </FluentSelect>
            </FluentStack>
        </FluentStack>
    }

    <FluentDialog @ref="_layoutEditorDialog"
                  @bind-Hidden="LayoutEditorHidden"
                  aria-label="Personnalisation de la grille"
                  Modal="true"
                  TrapFocus="true"
                  @ondialogdismiss="OnLayoutEditorDismiss">

        <FluentDialogHeader>
            <FluentLabel Typo="Typography.H5">Personnalisation de la grille</FluentLabel>
        </FluentDialogHeader>

        <FluentDialogBody>
            <div class="layout-dialog-body">
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                        <FluentLabel>√âl√©ments par page</FluentLabel>
                        <FluentNumberField TValue="int"
                                           Min="5"
                                           Max="200"
                                           Value="@_pageSizeDraft"
                                           ValueChanged="@((int value) => _pageSizeDraft = value)" />
                    </FluentStack>

                    @* üëâ Zone scrollable responsive *@
                    <div class="field-dialog-scroll">
                        <FluentDataGrid Items="@_columnsDraft.AsQueryable()"
                                        TGridItem="DynamicColumnDefinition"
                                        Style="min-width:100%;">
                            <PropertyColumn Property="@(c => c.DisplayName)" Title="Colonne" />
                            <TemplateColumn Title="Visible">
                                <ChildContent Context="column">
                                    <FluentCheckbox @bind-Value="column.Visible" />
                                </ChildContent>
                            </TemplateColumn>

                            <TemplateColumn Title="Ordre">
                                <ChildContent Context="column">
                                    <FluentNumberField TValue="int"
                                                       Value="@column.Order"
                                                       ValueChanged="@((int value) => column.Order = value)"
                                                       Style="width: 80px;" />
                                </ChildContent>
                            </TemplateColumn>
                        </FluentDataGrid>
                    </div>
                </FluentStack>
            </div>
        </FluentDialogBody>

        <FluentDialogFooter>
            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8">
                <FluentButton Appearance="Appearance.Accent" OnClick="SaveLayoutAsync">Sauvegarder</FluentButton>
                <FluentButton Appearance="Appearance.Stealth" OnClick="CloseLayoutEditor">Fermer</FluentButton>
            </FluentStack>
        </FluentDialogFooter>
    </FluentDialog>


</div>

@code {
    [Inject] public Aion.DataEngine.Interfaces.IDataEngine DataEngine { get; set; } = default!;
    [Inject] public Aion.DataEngine.Interfaces.IUserContext UserContext { get; set; } = default!;
    [Inject] public IDynamicLayoutStore LayoutStore { get; set; } = default!;

    [Parameter] public string TableName { get; set; } = string.Empty;
    [Parameter] public EventCallback<DynamicRow> OnRowDoubleClick { get; set; }

    private STable? _tableMetadata;
    private readonly List<DynamicColumnDefinition> _columns = new();
    private readonly List<DynamicRow> _rows = new();
    private readonly Dictionary<string, string?> _searchValues = new(StringComparer.OrdinalIgnoreCase);
    private readonly List<int> _pageSizes = new() { 10, 20, 50, 100 };
    private readonly List<DynamicColumnDefinition> _columnsDraft = new();
    private readonly List<DynamicColumnDefinition> _searchableColumns = new();

    private bool _isLoading = true;
    private int _page = 1;
    private int _pageSize = 20;
    private int _pageSizeDraft = 20;
    private int _pageCount = 1;
    private int _filteredCount = 0;
    private string? _errorMessage;
    private string? _loadedTableName;
    private string? _primaryKeyName;
    private FluentDialog? _layoutEditorDialog;
    private bool _layoutEditorOpen;
    
    private sealed class SortDescriptor
    {
        public string FieldName { get; set; } = string.Empty;
        public bool Descending { get; set; }
    }
    private readonly List<SortDescriptor> _sortDescriptors = new();

    private bool LayoutEditorHidden
    {
        get => !_layoutEditorOpen;
        set => _layoutEditorOpen = !value;
    }

    private async Task OnColumnHeaderClick(DynamicColumnDefinition column, MouseEventArgs e)
    {
        var multi = e.CtrlKey || e.ShiftKey; // clic simple = mono-tri, Ctrl/Shift+clic = multi-tri

        if (!multi)
        {
            // Mono-tri : soit on inverse sur la m√™me colonne, soit on repart de z√©ro
            var existing = _sortDescriptors.FirstOrDefault(s =>
                string.Equals(s.FieldName, column.FieldName, StringComparison.OrdinalIgnoreCase));

            if (existing != null && _sortDescriptors.Count == 1)
            {
                existing.Descending = !existing.Descending;
            }
            else
            {
                _sortDescriptors.Clear();
                _sortDescriptors.Add(new SortDescriptor
                {
                    FieldName = column.FieldName,
                    Descending = false
                });
            }
        }
        else
        {
            // Multi-tri (Ctrl/Shift) : on ajoute ou on inverse uniquement cette colonne
            var existing = _sortDescriptors.FirstOrDefault(s =>
                string.Equals(s.FieldName, column.FieldName, StringComparison.OrdinalIgnoreCase));

            if (existing != null)
            {
                existing.Descending = !existing.Descending;
            }
            else
            {
                _sortDescriptors.Add(new SortDescriptor
                {
                    FieldName = column.FieldName,
                    Descending = false
                });
            }
        }

        await LoadPageAsync(resetPage: true);
    }

    /// <summary>
    /// Comparaison tol√©rante pour object? : g√®re null, IComparable, string, etc.
    /// </summary>
    private int CompareValues(object? x, object? y)
    {
        if (ReferenceEquals(x, y)) return 0;
        if (x is null) return -1;
        if (y is null) return 1;

        // Si les types sont comparables directement
        if (x is IComparable cx && x.GetType() == y.GetType())
            return cx.CompareTo(y);

        // Fallback : comparaison en string
        return string.Compare(x.ToString(), y.ToString(), StringComparison.CurrentCultureIgnoreCase);
    }

    private void OpenLayoutEditor()
    {
        PrepareLayoutDraft();
        _layoutEditorOpen = true;
    }

    private void CloseLayoutEditor()
    {
        _layoutEditorOpen = false;
    }

    private void OnLayoutEditorDismiss(DialogEventArgs args)
    {
        CloseLayoutEditor();
    }

    private IReadOnlyList<DynamicColumnDefinition> VisibleColumns
        => _columns.Where(c => c.Visible).OrderBy(c => c.Order).ToList();

    private string GridTemplateColumns
    {
        get
        {
            var parts = VisibleColumns.Select(_ => "minmax(120px, 1fr)").ToList();
            parts.Add("200px");
            return string.Join(' ', parts);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.Equals(TableName, _loadedTableName, StringComparison.OrdinalIgnoreCase))
        {
            await LoadAsync();
        }
    }

    private async Task LoadAsync()
    {
        _isLoading = true;
        _errorMessage = null;
        _loadedTableName = TableName;
        _columns.Clear();
        _rows.Clear();
        _searchValues.Clear();
        _searchableColumns.Clear();
        _sortDescriptors.Clear();
        StateHasChanged();

        if (string.IsNullOrWhiteSpace(TableName))
        {
            _tableMetadata = null;
            _isLoading = false;
            return;
        }

        try
        {
            _tableMetadata = await DataEngine.GetTableMetadataAsync(TableName);
            if (_tableMetadata is null)
            {
                _errorMessage = $"Table '{TableName}' introuvable.";
                _isLoading = false;
                return;
            }

            var fields = await DataEngine.GetFieldsMetadataAsync(_tableMetadata.Id);
            foreach (var field in fields.OrderBy(f => f.Ordre ?? int.MaxValue).ThenBy(f => f.Libelle))
            {
                if (!field.IsLinkToBdd)
                {
                    continue;
                }

                var column = new DynamicColumnDefinition(field);
                _columns.Add(column);
                if (column.IsSearchable)
                {
                    _searchableColumns.Add(column);
                    if (!string.IsNullOrWhiteSpace(column.DefaultSearchValue))
                    {
                        _searchValues[column.FieldName] = column.DefaultSearchValue;
                    }
                }
            }

            _primaryKeyName = _columns.FirstOrDefault(c => c.IsPrimaryKey)?.FieldName
                ?? _columns.FirstOrDefault(c => string.Equals(c.FieldName, "Id", StringComparison.OrdinalIgnoreCase))?.FieldName;

            await LoadLayoutAsync();
            await LoadReferentialsAsync();
            await LoadPageAsync(resetPage: true);
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadReferentialsAsync()
    {
        foreach (var column in _columns.Where(c => c.IsReference))
        {
            try
            {
                var dt = await DataEngine.GetReferentialAsync(column.Field.Referentiel!, column.Field.ReferentielWhereClause);
                var options = new List<DynamicOption>();
                foreach (System.Data.DataRow row in dt.Rows)
                {
                    var value = row.Table.Columns.Contains("Id") ? row["Id"] : row[0];
                    var label = row.Table.Columns.Contains("Libelle") ? row["Libelle"] : null;
                    if (label is null)
                    {
                        label = row.Table.Columns.Cast<System.Data.DataColumn>()
                            .Select(c => row[c])
                            .FirstOrDefault(v => v is string);
                    }

                    options.Add(new DynamicOption
                    {
                        Value = value?.ToString() ?? string.Empty,
                        Label = label?.ToString() ?? value?.ToString() ?? string.Empty
                    });
                }
                column.Options = options;
            }
            catch
            {
                column.Options = new List<DynamicOption>();
            }
        }
    }


    private async Task LoadLayoutAsync()
    {
        try
        {
            var layout = await LayoutStore.LoadLayoutAsync(TableName, UserContext.TenantId, UserContext.UserId, CancellationToken.None);
            if (layout != null)
            {
                foreach (var column in _columns)
                {
                    var persisted = layout.Columns.FirstOrDefault(c => string.Equals(c.FieldName, column.FieldName, StringComparison.OrdinalIgnoreCase));
                    if (persisted != null)
                    {
                        column.Visible = persisted.Visible;
                        column.Order = persisted.Order;
                    }
                }

                if (layout.PageSize > 0)
                {
                    _pageSize = layout.PageSize;
                }

                // üëâ Nouveau : restaurer le multi-tri
                _sortDescriptors.Clear();
                if (layout.Sorts != null && layout.Sorts.Count > 0)
                {
                    foreach (var s in layout.Sorts.OrderBy(s => s.Order))
                    {
                        // Ne conserver que les colonnes qui existent encore
                        if (_columns.Any(c => string.Equals(c.FieldName, s.FieldName, StringComparison.OrdinalIgnoreCase)))
                        {
                            _sortDescriptors.Add(new SortDescriptor
                            {
                                FieldName = s.FieldName,
                                Descending = s.Descending
                            });
                        }
                    }
                }
            }
        }
        catch
        {
            // Ignorer les erreurs de lecture de layout
        }
        finally
        {
            _page = 1;
            _pageCount = 1;
            _pageSizeDraft = _pageSize;
        }
    }


    private async Task LoadPageAsync(bool resetPage = false)
    {
        if (string.IsNullOrWhiteSpace(TableName))
        {
            _rows.Clear();
            _filteredCount = 0;
            _pageCount = 1;
            return;
        }

        if (resetPage)
        {
            _page = 1;
        }

        try
        {
            _errorMessage = null;
            var filters = _searchValues
                .Where(kvp => !string.IsNullOrWhiteSpace(kvp.Value))
                .Select(kvp =>
                {
                    var column = _columns.FirstOrDefault(c => string.Equals(c.FieldName, kvp.Key, StringComparison.OrdinalIgnoreCase));
                    var op = column?.SearchOperator ?? "contains";
                    return new DataFilter(kvp.Key, kvp.Value, op);
                })
                .ToList();

            var sorts = _sortDescriptors
                .Select(sd => new DataSort(sd.FieldName, sd.Descending))
                .ToList();

            var request = new DataPageRequest(TableName, (_page - 1) * _pageSize, _pageSize, filters, sorts);
            var page = await DataEngine.GetPageAsync(request, CancellationToken.None);

            _rows.Clear();

            foreach (var rowValues in page.Rows)
            {
                var dict = new Dictionary<string, object?>(rowValues, StringComparer.OrdinalIgnoreCase);
                var row = new DynamicRow(dict)
                {
                    PrimaryKeyName = _primaryKeyName,
                    PrimaryKeyValue = _primaryKeyName is not null && dict.TryGetValue(_primaryKeyName, out var pk) ? pk : null,
                };

                var firstColumn = VisibleColumns.FirstOrDefault();
                row.DisplayLabel = firstColumn is not null ? row.GetValueAsString(firstColumn.FieldName) : null;
                _rows.Add(row);
            }

            _filteredCount = page.TotalCount;
            _pageCount = Math.Max(1, (int)Math.Ceiling(page.TotalCount / (double)_pageSize));

            if (_page > _pageCount)
            {
                _page = _pageCount;
                if (page.TotalCount > 0)
                {
                    await LoadPageAsync();
                }
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
    }

    private async Task OnSearchChanged(string fieldName, string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            _searchValues.Remove(fieldName);
        }
        else
        {
            _searchValues[fieldName] = value;
        }

        await LoadPageAsync(resetPage: true);
    }

    private string? GetSearchValue(string fieldName)
        => _searchValues.TryGetValue(fieldName, out var value) ? value : string.Empty;

    private async Task PrevPage()
    {
        if (_page > 1)
        {
            _page--;
            await LoadPageAsync();
        }
    }

    private async Task NextPage()
    {
        if (_page < _pageCount)
        {
            _page++;
            await LoadPageAsync();
        }
    }

    private async Task OnPageSizeChangedFluent(int size)
    {
        if (size > 0)
        {
            _pageSize = size;
            _pageSizeDraft = size;
            _page = 1;
            await LoadPageAsync();
        }
    }

    private decimal? ParseDecimalOrNull(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return null;
        return decimal.TryParse(value, out var result) ? result : null;
    }

    private RenderFragment RenderReadCell(DynamicRow row, DynamicColumnDefinition column) => builder =>
    {
        var value = row.GetValue(column.FieldName);
        if (column.InputKind == DynamicColumnInputKind.Boolean && value is bool boolValue)
        {
            builder.OpenComponent<FluentBadge>(0);
            builder.AddAttribute(1, nameof(FluentBadge.Appearance), boolValue ? Appearance.Accent : Appearance.Neutral);
            builder.AddAttribute(2, "ChildContent", (RenderFragment)((b) => b.AddContent(3, boolValue ? "Oui" : "Non")));
            builder.CloseComponent();
        }
        else if (column.IsReference && column.Options is not null)
        {
            var strValue = value?.ToString();
            var label = column.Options.FirstOrDefault(o => string.Equals(o.Value, strValue, StringComparison.OrdinalIgnoreCase))?.Label ?? strValue;
            builder.OpenComponent<FluentLabel>(0);
            builder.AddAttribute(1, "ChildContent", (RenderFragment)((b) => b.AddContent(2, label)));
            builder.CloseComponent();
        }
        else
        {
            builder.OpenComponent<FluentLabel>(0);
            builder.AddAttribute(1, "ChildContent", (RenderFragment)((b) => b.AddContent(2, row.GetValueAsString(column.FieldName))));
            builder.CloseComponent();
        }
    };

    private RenderFragment RenderEditCell(DynamicRow row, DynamicColumnDefinition column) => builder =>
    {
        switch (column.InputKind)
        {
            case DynamicColumnInputKind.Boolean:
                builder.OpenComponent<FluentCheckbox>(0);
                builder.AddAttribute(1, "Value", row.GetEditBool(column.FieldName));
                builder.AddAttribute(2, "ValueChanged", EventCallback.Factory.Create<bool>(this, value => row.SetEditBool(column.FieldName, value)));
                builder.CloseComponent();
                break;
            case DynamicColumnInputKind.Date:
                builder.OpenElement(0, "input");
                builder.AddAttribute(1, "type", "date");
                builder.AddAttribute(2, "class", "form-control");
                builder.AddAttribute(3, "value", row.GetEditValue(column.FieldName));
                builder.AddAttribute(4, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(this, e => row.SetEditValue(column.FieldName, e.Value?.ToString())));
                builder.CloseElement();
                break;
            case DynamicColumnInputKind.DateTime:
                builder.OpenElement(0, "input");
                builder.AddAttribute(1, "type", "datetime-local");
                builder.AddAttribute(2, "class", "form-control");
                builder.AddAttribute(3, "value", row.GetEditValue(column.FieldName));
                builder.AddAttribute(4, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(this, e => row.SetEditValue(column.FieldName, e.Value?.ToString())));
                builder.CloseElement();
                break;
            case DynamicColumnInputKind.Number:
                builder.OpenComponent<FluentNumberField<int?>>(0);
                builder.AddAttribute(1, "Value", ParseIntOrNull(row.GetEditValue(column.FieldName)));
                builder.AddAttribute(2, "ValueChanged", EventCallback.Factory.Create<int?>(this, value => row.SetEditValue(column.FieldName, value?.ToString())));
                builder.CloseComponent();
                break;
            case DynamicColumnInputKind.Decimal:
                builder.OpenComponent<FluentNumberField<decimal?>>(0);
                builder.AddAttribute(1, "Value", ParseDecimalOrNull(row.GetEditValue(column.FieldName)));
                builder.AddAttribute(2, "ValueChanged", EventCallback.Factory.Create<decimal?>(this, value => row.SetEditValue(column.FieldName, value?.ToString())));
                builder.CloseComponent();
                break;
            case DynamicColumnInputKind.Select when column.Options is not null:
                builder.OpenComponent<FluentSelect<string>>(0);
                builder.AddAttribute(1, "Value", row.GetEditValue(column.FieldName));
                builder.AddAttribute(2, "ValueChanged", EventCallback.Factory.Create<string?>(this, value => row.SetEditValue(column.FieldName, value)));
                builder.AddAttribute(3, "Items", column.Options.Select(o => o.Value));
                builder.AddAttribute(4, "OptionText", (Func<string, string>)(val => column.Options.FirstOrDefault(o => o.Value == val)?.Label ?? val));
                builder.CloseComponent();
                break;
            default:
                builder.OpenComponent<FluentTextField>(0);
                builder.AddAttribute(1, "Value", row.GetEditValue(column.FieldName));
                builder.AddAttribute(2, "ValueChanged", EventCallback.Factory.Create<string?>(this, value => row.SetEditValue(column.FieldName, value)));
                builder.CloseComponent();
                break;
        }
    };

    private int? ParseIntOrNull(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return null;
        return int.TryParse(value, out var result) ? result : null;
    }

    private async Task SaveRowAsync(DynamicRow row)
    {
        try
        {
            var values = new Dictionary<string, object?>(StringComparer.OrdinalIgnoreCase);
            foreach (var column in _columns)
            {
                if (column.IsPrimaryKey && !row.IsNew)
                {
                    continue;
                }

                var rawValue = row.GetEditValue(column.FieldName);
                var typedValue = ConvertToType(column, rawValue);
                values[column.FieldName] = typedValue;
            }

            if (row.IsNew)
            {
                await DataEngine.InsertAsync(TableName, values);
                await LoadPageAsync(resetPage: true);
            }
            else if (row.HasPrimaryKey && row.PrimaryKeyValue is not null)
            {
                await DataEngine.UpdateAsync(TableName, row.PrimaryKeyName!, row.PrimaryKeyValue, values);
                await LoadPageAsync();
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
    }

    private async Task DeleteRowAsync(DynamicRow row)
    {
        if (!row.HasPrimaryKey || row.PrimaryKeyValue is null)
        {
            return;
        }

        try
        {
            await DataEngine.DeleteAsync(TableName, row.PrimaryKeyName!, row.PrimaryKeyValue);
            await LoadPageAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
    }

    private void StartEdit(DynamicRow row)
    {
        row.IsEditing = true;
        row.IsNew = false;
        row.ClearEditValues();
        foreach (var column in _columns)
        {
            if (row.GetValue(column.FieldName) is { } value)
            {
                if (column.InputKind == DynamicColumnInputKind.Boolean && value is bool boolValue)
                {
                    row.SetEditBool(column.FieldName, boolValue);
                }
                else
                {
                    row.SetEditValue(column.FieldName, value?.ToString());
                }
            }
        }
    }

    private void CancelEdit(DynamicRow row)
    {
        if (row.IsNew)
        {
            _rows.Remove(row);
        }
        else
        {
            row.IsEditing = false;
            row.IsNew = false;
            row.ClearEditValues();
        }
        StateHasChanged();
    }

    private void CreateRow()
    {
        var dict = _columns.ToDictionary(c => c.FieldName, _ => (object?)null, StringComparer.OrdinalIgnoreCase);
        var row = new DynamicRow(dict)
        {
            IsNew = true,
            IsEditing = true,
            PrimaryKeyName = _primaryKeyName
        };
        _rows.Insert(0, row);
        _page = 1;
        StateHasChanged();
    }

    private async Task ReloadAsync()
        => await LoadAsync();

    private object? ConvertToType(DynamicColumnDefinition column, string? rawValue)
    {
        if (string.IsNullOrWhiteSpace(rawValue))
        {
            return column.IsNullable ? null : rawValue;
        }

        var type = column.DataType.ToLowerInvariant();
        try
        {
            if (column.InputKind == DynamicColumnInputKind.Boolean)
            {
                return bool.TryParse(rawValue, out var boolValue) && boolValue;
            }
            if (column.InputKind == DynamicColumnInputKind.Number)
            {
                return int.TryParse(rawValue, out var intValue) ? intValue : Convert.ToInt32(rawValue);
            }
            if (column.InputKind == DynamicColumnInputKind.Decimal)
            {
                return decimal.TryParse(rawValue, out var dec) ? dec : Convert.ToDecimal(rawValue);
            }
            if (column.InputKind == DynamicColumnInputKind.Date || column.InputKind == DynamicColumnInputKind.DateTime)
            {
                return DateTime.TryParse(rawValue, out var date) ? date : rawValue;
            }
            if (type.Contains("bigint"))
            {
                return long.TryParse(rawValue, out var l) ? l : Convert.ToInt64(rawValue);
            }
            if (type.Contains("uniqueidentifier"))
            {
                return Guid.TryParse(rawValue, out var guid) ? guid : null;
            }
            if (column.IsReference)
            {
                if (int.TryParse(rawValue, out var refId))
                {
                    return refId;
                }
            }
        }
        catch
        {
            return rawValue;
        }

        return rawValue;
    }

    private async Task HandleRowDoubleClick(DynamicRow row)
    {
        if (OnRowDoubleClick.HasDelegate)
        {
            await OnRowDoubleClick.InvokeAsync(row);
        }
    }

    private async Task SaveLayoutAsync()
    {
        var layout = new DynamicGridLayout
        {
            PageSize = _pageSizeDraft,
            Columns = _columnsDraft.Select(c => new DynamicGridColumnLayout
            {
                FieldName = c.FieldName,
                Visible = c.Visible,
                Order = c.Order
            }).ToList(),

            // üëâ Nouveau : enregistrer les tris courants
            Sorts = _sortDescriptors
                .Select((sd, index) => new DynamicGridSortLayout
                {
                    FieldName = sd.FieldName,
                    Order = index,
                    Descending = sd.Descending
                }).ToList()
        };

        await LayoutStore.SaveLayoutAsync(TableName, UserContext.TenantId, UserContext.UserId, layout, CancellationToken.None);

        // Colonnes comme avant
        foreach (var draft in _columnsDraft)
        {
            var column = _columns.FirstOrDefault(c => string.Equals(c.FieldName, draft.FieldName, StringComparison.OrdinalIgnoreCase));
            if (column is null)
            {
                continue;
            }
            column.Visible = draft.Visible;
            column.Order = draft.Order;
        }

        _pageSize = _pageSizeDraft;
        _layoutEditorOpen = false;
        _page = 1;
        await LoadPageAsync(resetPage: true);
    }


    private void PrepareLayoutDraft()
    {
        _columnsDraft.Clear();
        foreach (var column in _columns)
        {
            _columnsDraft.Add(new DynamicColumnDefinition(column.Field)
            {
                Visible = column.Visible,
                Order = column.Order
            });
        }
        _pageSizeDraft = _pageSize;
    }
}
@inherits LayoutComponentBase
@using Aion.AppHost.Services
@using Aion.AppHost.Services.Navigation
@using Aion.Domain.UI.Navigation
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.FluentUI.AspNetCore.Components
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons;
@inject AuthenticationStateProvider Auth
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IAionThemeService ThemeService
@implements IDisposable

<FluentDesignTheme Mode="@ThemeService.Current.Mode"
                   NeutralBaseColor="@ThemeService.Current.NeutralBaseColor"
                   OfficeColor="@ThemeService.Current.OfficeColor"
                   CustomColor="@ThemeService.Current.CustomColor">
    <div class="@ShellClass">
        <header class="aion-topbar">
            <div class="aion-topbar-left" @onclick="@(() => Navigation.NavigateTo("/"))">
                <FluentIcon Value='@FluentIconResolver.Resolve("Apps24Regular")' />
                <span>Aion</span>
            </div>

            <div class="aion-topbar-center">
                @if (_isAuthenticated)
                {
                    <FluentButton Appearance="Appearance.Stealth"
                                  Class="aion-command-button"
                                  OnClick="OpenCommandPalette">
                        <FluentIcon Value='@FluentIconResolver.Resolve("Search20Regular")' />
                        <span>Rechercher ou exécuter une commande</span>
                        <kbd>Ctrl</kbd><span class="plus">+</span><kbd>K</kbd>
                    </FluentButton>
                }
            </div>

            <div class="aion-topbar-right">
                <FluentSelect TOption="string"
                              Value="_selectedTheme"
                              ValueChanged="OnThemeSelectionChanged"
                              Style="min-width: 140px;">
                    <FluentOption Value="light">Thème clair</FluentOption>
                    <FluentOption Value="dark">Thème sombre</FluentOption>
                </FluentSelect>

                @if (_isAuthenticated)
                {
                    <FluentMenu>
                        <FluentMenuButton>
                            <FluentLabel Name="@_username" />
                        </FluentMenuButton>
                        <FluentMenu>
                            <FluentMenuItem OnClick="Logout">Se déconnecter</FluentMenuItem>
                        </FluentMenu>
                    </FluentMenu>
                }
            </div>
        </header>

        <div class="aion-body">
            @if (_isAuthenticated)
            {
                <nav class="aion-side-rail">
                    <FluentButton Appearance="Appearance.Stealth" StartIcon='@FluentIconResolver.Resolve("Home20Regular")' OnClick="@(() => Navigation.NavigateTo("/"))" />
                    <FluentButton Appearance="Appearance.Stealth" StartIcon='@FluentIconResolver.Resolve("Search20Regular")' OnClick="OpenCommandPalette" />
                    <FluentButton Appearance="Appearance.Stealth" StartIcon='@FluentIconResolver.Resolve("CalendarLtr20Regular")' OnClick="@(() => Navigation.NavigateTo("/agenda"))" />
                    <FluentButton Appearance="Appearance.Stealth" StartIcon='@FluentIconResolver.Resolve("Apps20Regular")' OnClick="@(() => Navigation.NavigateTo("/modules"))" />
                    <FluentButton Appearance="Appearance.Stealth" StartIcon='@FluentIconResolver.Resolve("Settings20Regular")' OnClick="@(() => Navigation.NavigateTo("/admin/catalog"))" />
                </nav>
            }

            <main class="aion-content">
                @if (_isAuthenticated)
                {
                    <ModuleHost />
                }
                else
                {
                    @Body
                }
            </main>
        </div>

        @if (_isAuthenticated)
        {
            <nav class="aion-bottom-nav">
                <FluentButton type="ButtonType.Button" @onclick="@(() => Navigation.NavigateTo("/"))">
                    <FluentIcon Value='@FluentIconResolver.Resolve("Home20Regular")' />
                    <FluentLabel>Accueil</FluentLabel>
                </FluentButton>
                <FluentButton type="ButtonType.Button" @onclick="OpenCommandPalette">
                    <FluentIcon Value='@FluentIconResolver.Resolve("Search20Regular")' />
                    <FluentLabel>Recherche</FluentLabel>
                </FluentButton>
                <FluentButton type="ButtonType.Button" @onclick="@(() => Navigation.NavigateTo("/agenda"))">
                    <FluentIcon Value='@FluentIconResolver.Resolve("CalendarLtr20Regular")' />
                    <FluentLabel>Agenda</FluentLabel>
                </FluentButton>
                <FluentButton type="ButtonType.Button" @onclick="@(() => Navigation.NavigateTo("/modules"))">
                    <FluentIcon Value='@FluentIconResolver.Resolve("Apps20Regular")' />
                    <FluentLabel>Modules</FluentLabel>
                </FluentButton>
                <FluentButton type="ButtonType.Button" @onclick="OpenUserMenu">
                    <FluentIcon Value='@FluentIconResolver.Resolve("Person20Regular")' />
                    <FluentLabel>Profil</FluentLabel>
                </FluentButton>
            </nav>
        }

        <CommandPalette @ref="_commandPalette" />
    </div>

    <FluentToastProvider />
    <FluentDialogProvider />
    <FluentTooltipProvider />
    <FluentMessageBarProvider />
    <FluentMenuProvider />
</FluentDesignTheme>

@code {
    private AuthenticationState? _authState;
    private bool _isAuthenticated;
    private string _selectedTheme = "dark";
    private string _username = "Utilisateur";
    private CommandPalette? _commandPalette;

    private bool IsDark => ThemeService.Current.Mode == DesignThemeModes.Dark;
    private string ShellClass => IsDark ? "aion-shell aion-shell-dark" : "aion-shell";

    protected override async Task OnInitializedAsync()
    {
        ThemeService.ThemeChanged += OnThemeChanged;
        _selectedTheme = ThemeService.Current.Mode == DesignThemeModes.Dark ? "dark" : "light";
        _authState = await Auth.GetAuthenticationStateAsync();
        _isAuthenticated = _authState.User.Identity?.IsAuthenticated == true;
        _username = _authState.User.Identity?.Name ?? _username;
    }

    private void OnThemeChanged()
    {
        _selectedTheme = ThemeService.Current.Mode == DesignThemeModes.Dark ? "dark" : "light";
        _ = InvokeAsync(StateHasChanged);
    }

    private Task OnThemeSelectionChanged(string? value)
    {
        if (string.Equals(value, "dark", StringComparison.OrdinalIgnoreCase))
        {
            ThemeService.UseDark();
        }
        else
        {
            ThemeService.UseLight();
        }

        return Task.CompletedTask;
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login", true);
    }

    private async Task OpenCommandPalette()
    {
        if (!_isAuthenticated)
        {
            return;
        }

        if (_commandPalette is not null)
        {
            await _commandPalette.OpenAsync();
        }
    }

    private void OpenUserMenu()
    {
        _ = OpenCommandPalette();
    }

    public void Dispose()
    {
        ThemeService.ThemeChanged -= OnThemeChanged;
    }
}

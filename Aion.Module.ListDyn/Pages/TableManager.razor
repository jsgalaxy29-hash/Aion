@page "/dynamic/manager"
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<Aion.Infrastructure.AionDbContext> DbFactory
@inject ITabService Tabs

<PageTitle>Mes tables</PageTitle>

<h1 class="h4 mb-3">Mes tables</h1>
<FluentTextField Placeholder="Filtrer" @bind-Value="_filter" Class="mb-3" />

@if (_tables is null)
{
    <div class="d-flex align-items-center gap-2"><FluentProgressRing /> Chargement des tables...</div>
}
else if (_tables.Count == 0)
{
    <div class="alert alert-info">Aucune table disponible.</div>
}
else
{
    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th>Nom</th>
                <th>Description</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var table in FilterTables())
            {
                <tr>
                    <td>@table.Libelle</td>
                    <td>@table.Description</td>
                    <td class="text-end">
                        <FluentButton Appearance="Appearance.Accent" OnClick="() => OpenTableAsync(table)" Size="ControlSize.Small">Ouvrir</FluentButton>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<STable>? _tables;
    private string _filter = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        _tables = await db.STable
            .AsNoTracking()
            .Where(t => t.Actif && !t.Deleted)
            .OrderBy(t => t.Libelle)
            .ToListAsync();
    }

    private IEnumerable<STable> FilterTables()
    {
        if (_tables is null)
        {
            return Enumerable.Empty<STable>();
        }

        if (string.IsNullOrWhiteSpace(_filter))
        {
            return _tables;
        }

        return _tables.Where(t => t.Libelle.Contains(_filter, StringComparison.OrdinalIgnoreCase)
            || (!string.IsNullOrWhiteSpace(t.Description) && t.Description.Contains(_filter, StringComparison.OrdinalIgnoreCase)));
    }

    private async Task OpenTableAsync(STable table)
    {
        var parameters = new Dictionary<string, object?> { ["TableName"] = table.Libelle };
        await Tabs.OpenAsync(table.Description ?? table.Libelle, "/dynamic/list", parameters, true, CancellationToken.None);
    }
}

@page "/dynamic/manager"
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<Aion.Infrastructure.AionDbContext> DbFactory
@inject IAionNavigationService Navigation
@inject IModuleCatalog ModuleCatalog
@inject NavigationManager NavigationManager

<FluentLabel Typo="Typography.PageTitle">Mes tables</FluentLabel>

<FluentTextField Placeholder="Filtrer" @bind-Value="_filter" Class="mb-3" />

@if (_tables is null)
{
    <div class="d-flex align-items-center gap-2"><FluentProgressRing /> Chargement des tables...</div>
}
else if (_tables.Count == 0)
{
    <div class="alert alert-info">Aucune table disponible.</div>
}
else
{
    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th><FluentLabel>Nom</FluentLabel></th>
                <th><FluentLabel>Description</FluentLabel></th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var table in FilterTables())
            {
                <tr>
                    <td><FluentLabel>@table.Libelle</FluentLabel></td>
                    <td><FluentLabel>@table.Description</FluentLabel></td>
                    <td class="text-end">
                        <FluentButton Appearance="Appearance.Accent" OnClick="@(async () => await OpenTableAsync(table))" Size="ControlSize.Small">Ouvrir</FluentButton>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<STable>? _tables;
    private string _filter = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        _tables = await db.STable
            .AsNoTracking()
            .Where(t => t.Actif && !t.Deleted)
            .OrderBy(t => t.Libelle)
            .ToListAsync();
    }

    private IEnumerable<STable> FilterTables()
    {
        if (_tables is null)
        {
            return Enumerable.Empty<STable>();
        }

        if (string.IsNullOrWhiteSpace(_filter))
        {
            return _tables;
        }

        return _tables.Where(t => t.Libelle.Contains(_filter, StringComparison.OrdinalIgnoreCase)
            || (!string.IsNullOrWhiteSpace(t.Description) && t.Description.Contains(_filter, StringComparison.OrdinalIgnoreCase)));
    }

    private async Task OpenTableAsync(STable table)
    {
        if (string.IsNullOrWhiteSpace(table.Libelle))
        {
            return;
        }

        var encoded = Uri.EscapeDataString(table.Libelle);
        var parameters = new Dictionary<string, object?> { ["TableName"] = table.Libelle };

        var listModule = await ModuleCatalog.TryGetByRouteAsync("/dynamic/list", CancellationToken.None);
        if (listModule is not null)
        {
            await Navigation.OpenModuleAsync(listModule.Key, parameters, CancellationToken.None);
            NavigationManager.NavigateTo($"/dynamic/list/{encoded}");

            var managerModule = await ModuleCatalog.TryGetByRouteAsync("/dynamic/manager", CancellationToken.None);
            if (managerModule is not null
                && !string.Equals(managerModule.Key, listModule.Key, StringComparison.OrdinalIgnoreCase))
            {
                await Navigation.CloseModuleAsync(managerModule.Key, CancellationToken.None);
            }

            return;
        }

        NavigationManager.NavigateTo($"/dynamic/list/{encoded}", true);
    }
}
